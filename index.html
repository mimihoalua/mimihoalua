<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MimiFlower - Thế Giới Hoa Lụa & Decor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 3px; height: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        @keyframes bounce-short { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .animate-bounce-short { animation: bounce-short 0.2s ease-in-out; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scroll-smooth { scroll-behavior: smooth; }

        .shopee-border-bottom {
            background-image: repeating-linear-gradient(45deg,#6fa6d6,#6fa6d6 33px,transparent 0,transparent 41px,#f18d9b 0,#f18d9b 74px,transparent 0,transparent 82px);
            background-position-x: -30px; background-size: 116px 3px; height: 3px; width: 100%;
        }

        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-in-item { animation: slideInRight 0.3s ease-out forwards; opacity: 0; }
        
        .error-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        .commune-option:hover { background-color: #f3f4f6; color: #ee4d2d; }
        .commune-option.selected { background-color: #fff7f6; color: #ee4d2d; font-weight: bold; }

        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; overscroll-behavior: none; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <header class="bg-gradient-to-r from-[#ee4d2d] to-[#ff7337] shadow-md sticky top-0 z-40 text-white">
        <div class="container mx-auto px-2 md:px-4">
            <div class="flex justify-between items-center text-xs md:text-sm py-1 border-b border-white/20 mb-2">
                <div class="flex gap-4"><a href="#" class="hover:text-gray-200">Kênh Người Bán</a><a href="#" class="hover:text-gray-200">Tải ứng dụng</a></div>
                <div class="flex gap-4"><a href="#" class="hover:text-gray-200">Thông báo</a><a href="#" class="hover:text-gray-200">Hỗ trợ</a></div>
            </div>
            <div class="flex items-center gap-4 py-2 pb-3">
                <a href="#" class="flex items-center gap-2 font-bold text-xl md:text-2xl tracking-tighter whitespace-nowrap"><i class="fa-solid fa-leaf"></i> MimiFlower</a>
                <div class="flex-1 max-w-2xl relative mx-2">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." class="w-full pl-4 pr-10 py-2 rounded-sm text-gray-800 focus:outline-none shadow-sm text-sm">
                    <button class="absolute right-1 top-1 bottom-1 bg-[#fb5533] px-4 rounded-sm text-white hover:opacity-90"><i class="fa-solid fa-search"></i></button>
                </div>
                <div class="relative px-2 cursor-pointer group" onclick="openCheckout()">
                    <i class="fa-solid fa-cart-shopping text-2xl md:text-3xl"></i>
                    <span id="cartCount" class="absolute -top-1 -right-1 bg-white text-[#ee4d2d] text-xs font-bold px-1.5 py-0.5 rounded-full border border-[#ee4d2d] shadow-sm transition-transform duration-200">0</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm border-b sticky top-[75px] z-30 hidden md:block">
        <div class="container mx-auto px-4 flex gap-8 text-sm font-medium text-gray-700 overflow-x-auto">
            <a href="#" class="py-3 text-[#ee4d2d] border-b-2 border-[#ee4d2d]">Trang Chủ</a>
            <a href="#" class="py-3 hover:text-[#ee4d2d]">Cây Giả Decor</a>
            <a href="#" class="py-3 hover:text-[#ee4d2d]">Hoa Lụa Cao Cấp</a>
            <a href="#" class="py-3 hover:text-[#ee4d2d]">Phụ Kiện Tết</a>
            <a href="#" class="py-3 hover:text-[#ee4d2d]">Chính Sách</a>
        </div>
    </nav>

    <main class="container mx-auto px-2 md:px-4 py-6 flex-grow">
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex items-center justify-between border-l-4 border-[#ee4d2d]">
            <div><h2 class="text-lg font-bold text-gray-800">GỢI Ý HÔM NAY</h2><p class="text-xs text-gray-500">Cập nhật xu hướng mới nhất</p></div>
            <a href="#" class="text-[#ee4d2d] text-sm font-medium hover:underline">Xem tất cả ></a>
        </div>
        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4">
            <div class="bg-white rounded shadow-sm p-2 animate-pulse h-64 col-span-full text-center py-10 text-gray-400">Đang tải sản phẩm...</div>
        </div>
    </main>

    <footer class="bg-[#2d2d2d] text-white pt-8 pb-4 mt-auto border-t-4 border-[#ee4d2d]">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between gap-6">
                <div class="md:w-1/3"><h3 class="text-xl font-bold text-[#ee4d2d] mb-2 font-serif italic">MIMIHOALUA</h3><p class="text-gray-400 text-xs">Chuyên cung cấp sỉ lẻ hoa lụa, cây giả.</p></div>
                <div class="md:w-1/3"><h4 class="text-sm font-bold uppercase mb-3 text-gray-300">Kết nối</h4><div class="flex gap-4"><a href="https://zalo.me/0348211187" target="_blank" class="bg-blue-600 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2"><i class="fa-solid fa-comment"></i> ZALO</a><a href="https://tiktok.com/@mimishophoalua" target="_blank" class="bg-black border border-gray-600 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-2"><i class="fa-brands fa-tiktok"></i> TikTok</a></div></div>
                <div class="md:w-1/3 text-xs text-gray-400 space-y-1"><p><i class="fa-solid fa-phone text-[#ee4d2d] mr-2"></i> 0348.211.187</p><p><i class="fa-solid fa-location-dot text-[#ee4d2d] mr-2"></i> Sóc Sơn, Hà Nội</p></div>
            </div>
            <div class="border-t border-gray-700 mt-6 pt-4 text-center text-[10px] text-gray-500">© 2025 MIMIHOALUA.</div>
        </div>
    </footer>

    <!-- MODAL CHI TIẾT -->
    <div id="detailModal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-0 md:p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0 overflow-y-auto">
        <!-- Container chính -->
        <div class="bg-white w-full h-full md:w-[1000px] md:h-auto md:max-h-[90vh] md:rounded-lg shadow-2xl flex flex-col md:flex-row relative transform scale-95 transition-transform duration-300 overflow-y-auto md:overflow-hidden" id="modalContent">
            
            <!-- Nút đóng -->
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-50 w-9 h-9 bg-black/40 text-white rounded-full flex items-center justify-center hover:bg-black/60 backdrop-blur-md shadow-lg transition-transform active:scale-90">
                <i class="fa-solid fa-times"></i>
            </button>

            <!-- CỘT TRÁI: KHU VỰC "ĂN TIỀN" -->
            <div class="w-full md:w-[58%] flex flex-col shrink-0 bg-white relative border-r border-gray-100 pb-6 md:pb-0">
                
                <!-- 1. ẢNH CHÍNH -->
                <div class="relative w-full aspect-square md:h-[480px] bg-white flex items-center justify-center group border-b border-gray-100">
                    <img id="modalMainImg" src="" class="w-full h-full object-contain p-2 transition-opacity duration-200">
                    
                    <button onclick="navigateGallery(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/90 text-gray-800 rounded-full flex items-center justify-center shadow-lg hover:bg-white transition-all active:scale-90 border border-gray-100">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <button onclick="navigateGallery(1)" class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/90 text-gray-800 rounded-full flex items-center justify-center shadow-lg hover:bg-white transition-all active:scale-90 border border-gray-100">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>

                    <div class="absolute top-0 left-0 bg-[#ee4d2d] text-white text-xs font-bold px-3 py-1 rounded-br shadow-sm z-10">Bán chạy</div>
                </div>

                <!-- 2. DẢI BIẾN THỂ -->
                <div class="relative w-full bg-gray-50 px-8 py-3 shadow-inner">
                    <button onclick="scrollThumbList(-1)" class="absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center text-gray-500 hover:text-[#ee4d2d] z-10 hover:bg-black/5"><i class="fa-solid fa-angle-left"></i></button>
                    
                    <div id="thumbList" class="flex gap-2 overflow-x-auto no-scrollbar scroll-smooth snap-x items-center h-[60px]">
                        <!-- Thumbnails injected here -->
                    </div>

                    <button onclick="scrollThumbList(1)" class="absolute right-0 top-0 bottom-0 w-8 flex items-center justify-center text-gray-500 hover:text-[#ee4d2d] z-10 hover:bg-black/5"><i class="fa-solid fa-angle-right"></i></button>
                </div>

                <!-- 3. THÔNG TIN CHỐT ĐƠN -->
                <div class="px-5 mt-4 space-y-4">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-500">Đang chọn:</span>
                        <span id="selectedVariantNameDisplay" class="font-bold text-gray-800 text-base border-b-2 border-[#ee4d2d]">...</span>
                    </div>

                    <div class="flex items-center gap-3 bg-[#ee4d2d]/5 p-3 rounded border border-[#ee4d2d]/10">
                        <div id="modalPrice" class="text-3xl font-bold text-[#ee4d2d]">-- ₫</div>
                        <div class="text-[10px] bg-[#ee4d2d] text-white px-2 py-0.5 rounded font-bold uppercase tracking-wide">Giá tốt</div>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Số lượng:</span>
                        <div class="flex items-center border border-gray-300 rounded shadow-sm">
                            <button onclick="updateQty(-1)" class="w-10 h-10 hover:bg-gray-100 text-gray-600 font-bold active:bg-gray-200 transition">-</button>
                            <input id="qtyInput" type="number" value="1" class="w-14 h-10 text-center text-base border-x border-gray-300 focus:outline-none font-bold text-[#ee4d2d]" readonly>
                            <button onclick="updateQty(1)" class="w-10 h-10 hover:bg-gray-100 text-gray-600 font-bold active:bg-gray-200 transition">+</button>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button onclick="addToCart()" class="flex-1 bg-[#ee4d2d]/10 border border-[#ee4d2d] text-[#ee4d2d] hover:bg-[#ee4d2d]/20 font-bold py-3.5 rounded shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-transform uppercase text-sm md:text-base">
                            <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ
                        </button>
                        <button onclick="buyNow()" class="flex-1 bg-gradient-to-r from-[#ee4d2d] to-[#ff7337] text-white font-bold py-3.5 rounded shadow-lg shadow-orange-500/30 hover:shadow-xl active:scale-95 transition-transform uppercase text-sm md:text-base">
                            Mua Ngay
                        </button>
                    </div>
                </div>
            </div>

            <!-- CỘT PHẢI: KHU VỰC THÔNG TIN (ĐỒNG BỘ 2 CHIỀU) -->
            <div class="w-full md:w-[42%] flex flex-col bg-gray-50 border-t md:border-t-0 md:border-l border-gray-100">
                <div class="p-5 space-y-5 overflow-y-auto custom-scrollbar flex-1">
                    
                    <!-- Tên Sản Phẩm Chính -->
                    <div>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 block">Sản phẩm</span>
                        <h2 id="modalTitle" class="text-xl md:text-2xl font-bold text-gray-800 leading-snug">...</h2>
                    </div>

                    <!-- Danh sách biến thể (Text List - Tương tác được) -->
                    <div class="bg-white p-4 rounded border border-gray-200 shadow-sm">
                        <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-2 flex items-center gap-2">
                            <i class="fa-solid fa-list-ul text-[#ee4d2d]"></i> Các tùy chọn:
                        </h4>
                        <!-- Container cho các nút text biến thể -->
                        <div id="variantListText" class="flex flex-wrap gap-2">
                            <!-- JS sẽ render buttons vào đây -->
                        </div>
                    </div>

                    <!-- Chính sách giao hàng -->
                    <div class="bg-white p-4 rounded border border-gray-200 shadow-sm space-y-3">
                        <h4 class="text-sm font-bold text-gray-700 border-b pb-2">Chính sách MimiFlower:</h4>
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0"><i class="fa-solid fa-truck-fast"></i></div>
                            <span>Giao hàng toàn quốc - Nhận hàng thanh toán</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0"><i class="fa-solid fa-box-open"></i></div>
                            <span>Được kiểm tra hàng trước khi nhận</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-gray-600">
                            <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 flex-shrink-0"><i class="fa-solid fa-rotate-left"></i></div>
                            <span>Đổi trả trong 7 ngày nếu lỗi</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL THANH TOÁN (CHECKOUT) - GIỮ NGUYÊN -->
    <div id="checkoutModal" class="fixed inset-0 bg-gray-100 hidden z-[60] overflow-y-auto transition-transform duration-300 translate-y-full">
       <div class="bg-white border-b sticky top-0 z-50 shadow-sm">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3"><div class="text-[#ee4d2d] text-2xl font-bold flex items-center gap-2"><i class="fa-solid fa-bag-shopping"></i> MimiFlower</div><div class="h-6 w-px bg-gray-300 mx-2"></div><div class="text-xl text-gray-700">Thanh Toán</div></div>
                <button onclick="closeCheckout()" class="text-gray-500 hover:text-[#ee4d2d] font-medium">Trở lại</button>
            </div>
        </div>
        <div class="container mx-auto px-4 py-6 pb-20">
             <div class="bg-white p-4 rounded shadow-sm mb-4">
                <h3 class="font-bold text-gray-800 mb-3"><i class="fa-solid fa-truck text-[#ee4d2d]"></i> Hình thức nhận hàng</h3>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer border p-3 rounded has-[:checked]:border-[#ee4d2d] has-[:checked]:bg-[#ee4d2d]/5 flex-1"><input type="radio" name="deliveryMethod" value="home" checked onchange="toggleDeliveryMethod()" class="accent-[#ee4d2d]"><span class="font-medium">Giao hàng tận nơi</span></label>
                    <label class="flex items-center gap-2 cursor-pointer border p-3 rounded has-[:checked]:border-[#ee4d2d] has-[:checked]:bg-[#ee4d2d]/5 flex-1"><input type="radio" name="deliveryMethod" value="store" onchange="toggleDeliveryMethod()" class="accent-[#ee4d2d]"><span class="font-medium">Nhận tại cửa hàng</span></label>
                </div>
            </div>
            
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="w-full lg:w-2/3 space-y-4">
                    <div id="formProgressContainer" class="bg-white px-6 pt-4 pb-2 rounded-t shadow-sm border-b relative">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Tiến độ điền đơn</span>
                            <span id="progressText" class="text-xs font-bold text-[#ee4d2d]">0/5 Hoàn thành</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-[#ee4d2d] h-2 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="addressFormSection" class="bg-white p-6 rounded-b shadow-sm relative overflow-hidden mt-0">
                        <div class="shopee-border-bottom absolute top-0 left-0"></div>
                        <h3 class="text-[#ee4d2d] text-lg font-bold mb-4 mt-2">Địa chỉ nhận hàng</h3>
                        <form id="checkoutForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm text-gray-600 mb-1">Họ và tên <span class="text-red-500">*</span></label><input type="text" id="cusName" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none transition-colors" placeholder="Nguyễn Văn A" oninput="checkFormProgress()"></div>
                                <div><label class="block text-sm text-gray-600 mb-1">Số điện thoại <span class="text-red-500">*</span></label><input type="tel" id="cusPhone" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none transition-colors" placeholder="09xxx..." oninput="checkFormProgress()"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm text-gray-600 mb-1">Tỉnh / Thành phố <span class="text-red-500">*</span></label><select id="selProvince" onchange="handleProvinceChange(); checkFormProgress()" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none bg-white transition-colors"><option value="">-- Chọn Tỉnh --</option></select></div>
                                <div class="relative group">
                                    <label class="block text-sm text-gray-600 mb-1">Phường / Xã <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <div class="relative">
                                            <input type="text" id="searchCommune" placeholder="-- Chọn Tỉnh trước --" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed bg-white pr-8" disabled autocomplete="off">
                                            <button type="button" onclick="clearCommuneSearch()" id="clearCommuneBtn" class="absolute right-8 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden p-1"><i class="fa-solid fa-times-circle"></i></button>
                                        </div>
                                        <input type="hidden" id="selCommune"> 
                                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-gray-400 text-xs pointer-events-none"></i>
                                        <div id="communeDropdown" class="absolute z-50 w-full bg-white border border-gray-200 shadow-xl rounded-b max-h-60 overflow-y-auto hidden mt-1 custom-scrollbar"></div>
                                    </div>
                                    <p class="text-xs text-[#ee4d2d] mt-2 font-medium bg-orange-50 p-1.5 rounded border border-orange-100 flex items-start gap-1.5"><i class="fa-regular fa-lightbulb mt-0.5 text-orange-500"></i><span>Mẹo: Gõ tên <b>Phường/Xã</b> hoặc <b>Quận/Huyện (tên cũ)</b> để tìm nhanh chính xác!</span></p>
                                </div>
                            </div>
                            <div><label class="block text-sm text-gray-600 mb-1">Địa chỉ cụ thể <span class="text-red-500">*</span></label><input type="text" id="cusAddress" placeholder="Số nhà, tên đường..." class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none transition-colors" oninput="checkFormProgress()"></div>
                            <div><label class="block text-sm text-gray-600 mb-1">Ghi chú</label><textarea id="cusNote" rows="2" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none"></textarea></div>
                        </form>
                    </div>

                    <div id="storePickupMsg" class="bg-blue-50 p-6 rounded shadow-sm hidden border border-blue-200">
                        <div class="flex items-start gap-3"><i class="fa-solid fa-store text-blue-600 text-xl mt-1"></i><div><h4 class="font-bold text-blue-800">Thông tin nhận hàng tại Shop</h4><p class="text-sm text-gray-600 mt-1">Địa chỉ: Số 3 Ngõ Văn Chỉ 1, Thôn Phù Mã, Xã Sóc Sơn, TP. Hà Nội</p><div class="mt-3"><label class="block text-sm font-medium mb-1">Tên & SĐT người nhận:</label><input type="text" id="storeCusInfo" placeholder="Nhập tên và SĐT của bạn..." class="w-full border p-2 rounded bg-white"></div></div></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow-sm">
                        <h3 class="text-gray-800 font-bold mb-4">Phương thức thanh toán</h3>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 border rounded cursor-pointer hover:bg-gray-50 has-[:checked]:border-[#ee4d2d] has-[:checked]:bg-[#ee4d2d]/5 transition-all"><input type="radio" name="payment" value="cod" checked onchange="togglePaymentMethod()" class="accent-[#ee4d2d] w-4 h-4"><i class="fa-solid fa-money-bill-wave text-green-600 text-xl"></i><div><div class="font-medium text-sm">Thanh toán khi nhận hàng (COD)</div></div></label>
                            <label class="flex items-center gap-3 p-3 border rounded cursor-pointer hover:bg-gray-50 has-[:checked]:border-[#ee4d2d] has-[:checked]:bg-[#ee4d2d]/5 transition-all"><input type="radio" name="payment" value="banking" onchange="togglePaymentMethod()" class="accent-[#ee4d2d] w-4 h-4"><i class="fa-solid fa-building-columns text-blue-600 text-xl"></i><div><div class="font-medium text-sm">Chuyển khoản ngân hàng</div></div></label>
                            <div id="bankingInfo" class="hidden mt-2 p-4 border border-blue-200 rounded-lg bg-blue-50/50 relative overflow-hidden transition-all duration-300">
                                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                <div class="text-center mb-4"><div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">Quét mã để thanh toán</div><div class="bg-white p-2 inline-block rounded border shadow-sm"><img id="qrCodeImg" src="" class="w-40 h-40 object-contain" alt="QR Code"></div><p class="text-[10px] text-gray-400 mt-1 italic">Mở App ngân hàng để quét</p></div>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center border-b border-blue-100 pb-2"><span class="text-gray-600">Ngân hàng:</span><span class="font-bold text-blue-800" id="bankNameDisplay">...</span></div>
                                    <div class="flex justify-between items-center border-b border-blue-100 pb-2"><span class="text-gray-600">Số tài khoản:</span><div class="flex items-center gap-2"><span class="font-bold text-gray-800" id="bankAccNumDisplay">...</span><button onclick="copyText(document.getElementById('bankAccNumDisplay').innerText)" class="text-blue-500 hover:text-blue-700"><i class="fa-regular fa-copy"></i></button></div></div>
                                    <div class="flex justify-between items-center border-b border-blue-100 pb-2"><span class="text-gray-600">Chủ tài khoản:</span><span class="font-bold text-gray-800 uppercase" id="bankOwnerDisplay">...</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">Nội dung:</span><div class="flex items-center gap-2"><span class="font-bold text-[#ee4d2d]" id="bankContent">...</span><button onclick="copyContent()" class="text-blue-500 hover:text-blue-700"><i class="fa-regular fa-copy"></i></button></div></div>
                                </div>
                                <div class="mt-4 bg-yellow-50 text-yellow-800 text-xs p-2 rounded border border-yellow-100 flex items-start gap-2"><i class="fa-solid fa-circle-exclamation mt-0.5"></i><span>Lưu ý: Vui lòng ghi đúng nội dung chuyển khoản để đơn hàng được xác nhận tự động.</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-1/3">
                    <div class="bg-white p-6 rounded shadow-sm sticky top-[80px]">
                        <div class="flex justify-between items-center border-b pb-2 mb-4"><h3 class="text-gray-800 font-bold">Đơn hàng</h3><span class="text-xs text-gray-500" id="cartTotalItems">0 sản phẩm</span></div>
                        <div id="checkoutCartItems" class="space-y-4 mb-4 max-h-[300px] overflow-y-auto custom-scrollbar"></div>
                        <div class="space-y-2 py-4 text-sm text-gray-600 border-t border-dashed">
                            <div class="flex justify-between"><span>Tạm tính:</span><span id="subTotalDisplay">0₫</span></div>
                            <div class="flex justify-between"><span>Phí vận chuyển:</span><span id="shippingDisplay">0₫</span></div>
                        </div>
                        <div class="flex justify-between items-center border-t pt-4 mb-6"><span class="text-gray-700 font-bold">Tổng thanh toán:</span><span id="finalTotalDisplay" class="text-2xl font-bold text-[#ee4d2d]">0₫</span></div>
                        <button onclick="submitOrder()" id="btnOrder" class="w-full bg-[#ee4d2d] hover:bg-[#d73211] text-white py-3 rounded shadow font-bold uppercase transition flex justify-center items-center gap-2">Đặt Hàng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST & MODALS (GIỮ NGUYÊN) -->
    <div id="toast" class="fixed top-20 right-4 bg-white border-l-4 border-green-500 text-gray-800 px-4 py-3 rounded shadow-2xl transform translate-x-full transition-transform duration-300 z-[90] flex items-center gap-3 min-w-[280px]"><div id="toastIcon" class="text-green-500 text-xl"><i class="fa-solid fa-circle-check"></i></div><div><div id="toastTitle" class="font-bold text-sm">Thành công!</div><div id="toastMsg" class="text-xs text-gray-500">Đã thêm vào giỏ hàng.</div></div></div>
    <div id="deleteModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity opacity-0"><div class="bg-white rounded-lg shadow-2xl w-[90%] max-w-sm overflow-hidden transform scale-95 opacity-0 transition-all duration-200 modal-content p-6 text-center"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl"><i class="fa-solid fa-trash-can"></i></div><h3 class="text-gray-800 font-bold text-lg mb-2">Xác nhận xoá?</h3><p class="text-gray-500 text-sm mb-6">Bạn có chắc chắn muốn xoá sản phẩm này khỏi giỏ hàng không?</p><div class="flex gap-3 justify-center"><button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded font-medium hover:bg-gray-300 transition">Huỷ bỏ</button><button onclick="confirmDelete()" class="px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-600 shadow-lg hover:shadow-red-500/30 transition transform active:scale-95">Xoá ngay</button></div></div></div>
    <div id="validationModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity opacity-0"><div class="bg-white rounded-lg shadow-2xl w-[90%] max-w-sm overflow-hidden transform scale-95 transition-transform duration-200" id="validationContent"><div class="bg-red-50 p-4 border-b border-red-100 flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-500 text-xl animate-pulse"><i class="fa-solid fa-triangle-exclamation"></i></div><h3 class="text-red-600 font-bold text-lg">Thông tin chưa đủ</h3></div><div class="p-5"><p class="text-gray-600 text-sm mb-3">Vui lòng bổ sung các thông tin sau để chúng tôi giao hàng:</p><ul id="errorList" class="space-y-2 text-sm text-gray-700"></ul></div><div class="p-3 bg-gray-50 text-right"><button onclick="closeValidationModal()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold hover:bg-gray-700">Đã hiểu</button></div><div class="h-1 bg-red-100 w-full"><div class="h-full bg-red-500 w-full animate-[width_3s_linear_reverse]"></div></div></div></div>

    <script>
        const BANK_ID = "TCB"; 
        const BANK_ACC_NUM = "19037189711011"; 
        const BANK_ACC_OWNER = "NGUYEN THI THAM";
        const BANK_NAME_DISPLAY = "TECHCOMBANK";

        const firebaseConfig = {
            apiKey: "AIzaSyDT0IEKhjAJZ_ZiMVwVCvO-fuj0ByReoE8",
            authDomain: "esomar-vnn.firebaseapp.com",
            projectId: "esomar-vnn",
            storageBucket: "esomar-vnn.firebasestorage.app",
            messagingSenderId: "1023271897973",
            appId: "1:1023271897973:web:c7207b0e8321fc271fe13c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ⚠️⚠️⚠️ DỮ LIỆU ĐỊA CHÍNH (FULL) 
        const vietnamLocations = [
             { "id": "01", "name": "TP. Hà Nội", "communes": [{ "id": "10123", "name": "Phường Biên Giang", "type": "Phường", "zone_hint": "Quận Hà Đông" }] } 
        ];

        let currentProduct = null;
        let selectedVariantIndex = 0;
        let cartItems = [];
        let itemToDeleteIndex = null; 

        window.onload = function() {
            loadProvinces();
            loadCart();
            setupCommuneSearch(); 
            setupBankInfo(); 
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById("communeDropdown");
                const searchInput = document.getElementById("searchCommune");
                if (!dropdown.contains(e.target) && e.target !== searchInput) dropdown.classList.add("hidden");
            });
        };

        function setupBankInfo() {
            document.getElementById("bankNameDisplay").innerText = BANK_NAME_DISPLAY;
            document.getElementById("bankAccNumDisplay").innerText = BANK_ACC_NUM;
            document.getElementById("bankOwnerDisplay").innerText = BANK_ACC_OWNER;
        }

        db.collection("products").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            const grid = document.getElementById("productGrid");
            grid.innerHTML = "";
            snapshot.forEach(doc => {
                const p = doc.data();
                p.id = doc.id;
                let thumb = p.variants?.[0]?.image || p.images?.[0] || "https://via.placeholder.com/300";
                let priceDisplay = new Intl.NumberFormat('vi-VN').format(p.basePrice);
                if (p.variants?.length > 1) {
                    const prices = p.variants.map(v => v.price);
                    priceDisplay = `${new Intl.NumberFormat('vi-VN').format(Math.min(...prices))} - ${new Intl.NumberFormat('vi-VN').format(Math.max(...prices))}`;
                }
                const card = document.createElement('div');
                card.className = "bg-white rounded-sm shadow-sm hover:shadow-md transition duration-200 cursor-pointer border border-transparent hover:border-[#ee4d2d] flex flex-col h-full";
                card.onclick = () => openDetail(p);
                card.innerHTML = `
                    <div class="aspect-square w-full relative overflow-hidden bg-gray-100"><img src="${thumb}" class="w-full h-full object-cover">
                        ${p.variants?.length > 1 ? '<div class="absolute bottom-0 right-0 bg-black/60 text-white text-[10px] px-1">Nhiều mẫu</div>' : ''}
                        <div class="absolute top-0 left-0 bg-[#ee4d2d] text-white text-[10px] font-bold px-2 py-0.5 rounded-br">Yêu thích</div>
                    </div>
                    <div class="p-2 flex flex-col flex-1"><div class="line-clamp-2 text-xs md:text-sm text-gray-800 mb-2 leading-tight min-h-[32px]">${p.name}</div><div class="mt-auto flex items-center justify-between"><span class="text-[#ee4d2d] font-bold text-sm md:text-base">₫${priceDisplay}</span><span class="text-[10px] text-gray-400">Đã bán 1.2k</span></div></div>`;
                grid.appendChild(card);
            });
        });

        // --- CART LOGIC ---
        function saveCart() { localStorage.setItem('mimiCart', JSON.stringify(cartItems)); }
        function loadCart() {
            const stored = localStorage.getItem('mimiCart');
            if (stored) {
                cartItems = JSON.parse(stored);
                updateCartBadge(cartItems.reduce((sum, item) => sum + item.qty, 0));
            }
        }
        function addToCart() {
            const qty = parseInt(document.getElementById("qtyInput").value);
            const variant = currentProduct.variants ? currentProduct.variants[selectedVariantIndex] : null;
            const price = variant ? variant.price : currentProduct.basePrice;
            const name = currentProduct.name;
            const image = variant ? variant.image : currentProduct.images[0];
            const variantName = variant ? variant.name : "Mặc định";

            cartItems.push({ id: currentProduct.id, name, price, qty, image, variant: variantName, timestamp: new Date().getTime() });
            saveCart();
            vibrate(); 
            updateCartBadge(cartItems.reduce((sum, item) => sum + item.qty, 0));
            showToast("Thêm thành công!", "Đã thêm sản phẩm vào giỏ.", "success");
            closeDetail();
        }
        function updateCartBadge(n) {
            const el = document.getElementById("cartCount");
            el.innerText = n;
            el.classList.remove("animate-bounce-short");
            void el.offsetWidth;
            el.classList.add("animate-bounce-short");
        }
        function showToast(title, msg, type = "success") {
            const toast = document.getElementById("toast");
            document.getElementById("toastTitle").innerText = title;
            document.getElementById("toastMsg").innerText = msg;
            toast.className = `fixed top-20 right-4 bg-white border-l-4 ${type==='success'?'border-green-500':'border-red-500'} text-gray-800 px-4 py-3 rounded shadow-2xl transform transition-transform duration-300 z-[90] flex items-center gap-3 min-w-[280px] toast-enter`;
            document.getElementById("toastIcon").className = `${type==='success'?'text-green-500':'text-red-500'} text-xl`;
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.remove("toast-enter"); toast.classList.add("translate-x-full"); }, 3000);
        }

        // --- MODAL & GALLERY LOGIC ---
        function openDetail(product) {
            currentProduct = product;
            selectedVariantIndex = 0;
            document.getElementById("qtyInput").value = 1;
            document.getElementById("modalTitle").innerText = product.name;
            
            // Render Text Variants (Right Column)
            const variantListText = document.getElementById("variantListText");
            variantListText.innerHTML = "";

            // Render Thumbnails (Left Column)
            const thumbList = document.getElementById("thumbList");
            thumbList.innerHTML = "";

            if (product.variants?.length > 0) {
                product.variants.forEach((v, index) => {
                    // Thumbs
                    const thumb = document.createElement("div");
                    thumb.className = `min-w-[48px] w-[48px] h-[48px] border-2 rounded cursor-pointer overflow-hidden snap-start transition-all shrink-0 ${index === 0 ? 'border-[#ee4d2d] opacity-100 ring-1 ring-[#ee4d2d]/30' : 'border-gray-200 opacity-60 hover:opacity-100'}`;
                    thumb.id = `thumb-${index}`;
                    thumb.onclick = () => { vibrate(); selectVariant(index); };
                    thumb.innerHTML = `<img src="${v.image || product.images[0]}" class="w-full h-full object-cover">`;
                    thumbList.appendChild(thumb);

                    // Text Buttons (Interactive)
                    const btn = document.createElement("button");
                    btn.id = `btn-text-var-${index}`;
                    // Default style (Inactive)
                    btn.className = "px-3 py-1.5 border border-gray-200 bg-white text-gray-600 rounded text-sm hover:border-gray-300 transition-all";
                    btn.innerText = v.name;
                    btn.onclick = () => { vibrate(); selectVariant(index); };
                    variantListText.appendChild(btn);
                });
                selectVariant(0);
            } else {
                thumbList.innerHTML = `<div class="min-w-[48px] w-[48px] h-[48px] border-2 border-[#ee4d2d] rounded overflow-hidden"><img src="${product.images[0]}" class="w-full h-full object-cover"></div>`;
                document.getElementById("modalMainImg").src = product.images[0];
                document.getElementById("modalPrice").innerText = new Intl.NumberFormat('vi-VN').format(product.basePrice) + ' ₫';
                document.getElementById("selectedVariantNameDisplay").innerText = "Mặc định";
                variantListText.innerHTML = "<span class='text-xs text-gray-400'>Không có phân loại</span>";
            }

            const modal = document.getElementById("detailModal");
            modal.classList.remove("hidden");
            requestAnimationFrame(() => { modal.classList.remove("opacity-0"); document.getElementById("modalContent").classList.add("scale-100"); });
        }

        function selectVariant(index) {
            selectedVariantIndex = index;
            const v = currentProduct.variants[index];
            
            // Update Info
            document.getElementById("modalMainImg").src = v.image || currentProduct.images[0];
            document.getElementById("modalPrice").innerText = new Intl.NumberFormat('vi-VN').format(v.price) + ' ₫';
            document.getElementById("selectedVariantNameDisplay").innerText = v.name;

            // Sync Thumbnails (Left)
            const allThumbs = document.getElementById("thumbList").children;
            for (let i = 0; i < allThumbs.length; i++) {
                if (i === index) {
                    allThumbs[i].className = "min-w-[48px] w-[48px] h-[48px] border-2 border-[#ee4d2d] rounded cursor-pointer overflow-hidden snap-start transition-all shrink-0 opacity-100 ring-1 ring-[#ee4d2d]/30 shadow-sm transform scale-105";
                    allThumbs[i].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    allThumbs[i].className = "min-w-[48px] w-[48px] h-[48px] border-2 border-gray-200 rounded cursor-pointer overflow-hidden snap-start transition-all shrink-0 opacity-60 hover:opacity-100";
                }
            }

            // Sync Text Buttons (Right)
            const allTextBtns = document.getElementById("variantListText").children;
            for (let i = 0; i < allTextBtns.length; i++) {
                if (i === index) {
                    // Active State (Orange)
                    allTextBtns[i].className = "px-3 py-1.5 border border-[#ee4d2d] bg-[#ee4d2d]/10 text-[#ee4d2d] rounded text-sm font-bold shadow-sm transition-all";
                } else {
                    // Inactive State
                    allTextBtns[i].className = "px-3 py-1.5 border border-gray-200 bg-white text-gray-600 rounded text-sm hover:border-gray-300 transition-all";
                }
            }
        }

        function navigateGallery(direction) {
            vibrate(); 
            if (!currentProduct.variants || currentProduct.variants.length <= 1) return;
            let newIndex = selectedVariantIndex + direction;
            if (newIndex < 0) newIndex = currentProduct.variants.length - 1;
            if (newIndex >= currentProduct.variants.length) newIndex = 0;
            selectVariant(newIndex);
        }

        function scrollThumbList(direction) {
            vibrate();
            const thumbList = document.getElementById("thumbList");
            thumbList.scrollBy({ left: direction * 150, behavior: 'smooth' });
        }

        function vibrate() { if (navigator.vibrate) navigator.vibrate(40); }

        function closeDetail() {
            const modal = document.getElementById("detailModal");
            modal.classList.add("opacity-0");
            document.getElementById("modalContent").classList.remove("scale-100");
            setTimeout(() => modal.classList.add("hidden"), 300);
        }
        function updateQty(change) {
            const input = document.getElementById("qtyInput");
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            input.value = val;
            vibrate();
        }
        function buyNow() { addToCart(); setTimeout(openCheckout, 300); }

        // --- CHECKOUT & HELPERS ---
        function openCheckout() {
            if(cartItems.length === 0) { alert("Giỏ hàng đang trống!"); return; }
            const modal = document.getElementById("checkoutModal");
            modal.classList.remove("hidden");
            requestAnimationFrame(() => modal.classList.remove("translate-y-full"));
            renderCheckoutItems();
            checkFormProgress(); 
            document.querySelector('input[name="payment"][value="cod"]').checked = true;
            togglePaymentMethod();
        }
        function closeCheckout() {
            const modal = document.getElementById("checkoutModal");
            modal.classList.add("translate-y-full");
            setTimeout(() => modal.classList.add("hidden"), 300);
        }
        function toggleDeliveryMethod() {
            const method = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const addrForm = document.getElementById("addressFormSection");
            const storeMsg = document.getElementById("storePickupMsg");
            const progressContainer = document.getElementById("formProgressContainer");
            if(method === 'home') { addrForm.classList.remove("hidden"); storeMsg.classList.add("hidden"); progressContainer.classList.remove("hidden"); updateShipping(30000); }
            else { addrForm.classList.add("hidden"); storeMsg.classList.remove("hidden"); progressContainer.classList.add("hidden"); updateShipping(0); }
        }
        function togglePaymentMethod() {
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const bankingInfo = document.getElementById("bankingInfo");
            if (paymentMethod === 'banking') { bankingInfo.classList.remove("hidden"); updateQRCode(); }
            else { bankingInfo.classList.add("hidden"); }
        }
        function updateQRCode() {
            const totalText = document.getElementById("finalTotalDisplay").innerText.replace(/\./g,'').replace('₫','');
            const amount = parseInt(totalText) || 0;
            const phone = document.getElementById("cusName").value ? document.getElementById("cusPhone").value : "KHACH";
            const content = `MIMI ${phone}`.trim();
            document.getElementById("bankContent").innerText = content;
            const template = "compact2"; 
            const qrUrl = `https://img.vietqr.io/image/${BANK_ID}-${BANK_ACC_NUM}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}`;
            document.getElementById("qrCodeImg").src = qrUrl;
        }
        document.getElementById("cusPhone").addEventListener("input", function() {
            if(document.querySelector('input[name="payment"]:checked').value === 'banking') {
                if(this.qrTimeout) clearTimeout(this.qrTimeout);
                this.qrTimeout = setTimeout(updateQRCode, 500);
            }
        });
        function copyText(text) { navigator.clipboard.writeText(text).then(() => showToast("Đã sao chép!", text, "success")); }
        function copyContent() { const text = document.getElementById("bankContent").innerText; copyText(text); }
        function renderCheckoutItems() {
            const container = document.getElementById("checkoutCartItems");
            const totalItemsEl = document.getElementById("cartTotalItems");
            let html = ""; let subTotal = 0;
            cartItems.forEach((item, index) => {
                const t = item.price * item.qty; subTotal += t;
                html += `<div class="flex gap-3 items-start border-b pb-3 last:border-0 relative group"><div class="absolute -left-2 -top-2 w-5 h-5 bg-gray-200 rounded-full text-center text-xs font-bold leading-5 text-gray-600 shadow-sm z-10">${index + 1}</div><div class="relative w-16 h-16 shrink-0"><img src="${item.image}" class="w-full h-full object-cover rounded border"></div><div class="flex-1 min-w-0"><div class="text-sm text-gray-800 line-clamp-2 font-medium">${item.name}</div><div class="text-xs text-gray-500 mt-1 bg-gray-100 inline-block px-1.5 py-0.5 rounded">Phân loại: ${item.variant}</div><div class="flex justify-between items-center mt-2"><div class="flex items-center border rounded"><button onclick="updateCartItemQty(${index}, -1)" class="w-6 h-6 hover:bg-gray-100 text-gray-600 font-bold">-</button><span class="text-xs px-2 w-8 text-center">${item.qty}</span><button onclick="updateCartItemQty(${index}, 1)" class="w-6 h-6 hover:bg-gray-100 text-gray-600 font-bold">+</button></div><span class="text-sm font-bold text-[#ee4d2d]">${new Intl.NumberFormat('vi-VN').format(t)}₫</span></div></div><button onclick="askDeleteItem(${index})" class="text-gray-300 hover:text-red-500 p-2 transition-colors duration-200"><i class="fa-solid fa-trash-can text-lg"></i></button></div>`;
            });
            container.innerHTML = html || "<div class='text-center text-gray-400 py-10 flex flex-col items-center gap-2'><i class='fa-solid fa-cart-arrow-down text-4xl text-gray-200'></i><span>Giỏ hàng trống</span></div>";
            totalItemsEl.innerText = `${cartItems.length} sản phẩm`;
            const method = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const ship = (method === 'home' && subTotal > 0) ? 30000 : 0;
            updateTotal(subTotal, ship);
        }
        function updateCartItemQty(index, delta) {
            if (cartItems[index].qty + delta >= 1) {
                cartItems[index].qty += delta; saveCart(); renderCheckoutItems(); updateCartBadge(cartItems.reduce((sum, item) => sum + item.qty, 0));
                if(document.querySelector('input[name="payment"]:checked').value === 'banking') { updateQRCode(); }
            }
        }
        function askDeleteItem(index) {
            itemToDeleteIndex = index; if (navigator.vibrate) navigator.vibrate(50);
            const modal = document.getElementById("deleteModal"); modal.classList.remove("hidden");
            requestAnimationFrame(() => { modal.classList.remove("opacity-0"); const content = modal.querySelector(".modal-content"); content.classList.remove("scale-95", "opacity-0"); content.classList.add("scale-100", "opacity-100"); });
        }
        function closeDeleteModal() {
            itemToDeleteIndex = null; const modal = document.getElementById("deleteModal"); modal.classList.add("opacity-0"); const content = modal.querySelector(".modal-content"); content.classList.remove("scale-100", "opacity-100"); content.classList.add("scale-95", "opacity-0"); setTimeout(() => modal.classList.add("hidden"), 200);
        }
        function confirmDelete() {
            if (itemToDeleteIndex !== null) {
                cartItems.splice(itemToDeleteIndex, 1); saveCart(); updateCartBadge(cartItems.reduce((sum, item) => sum + item.qty, 0)); renderCheckoutItems();
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]); showToast("Đã xoá!", "Sản phẩm đã bị xoá khỏi giỏ.", "error");
                if(cartItems.length === 0) closeCheckout();
                if(document.querySelector('input[name="payment"]:checked').value === 'banking') { updateQRCode(); }
                closeDeleteModal();
            }
        }
        function updateShipping(fee) { const subText = document.getElementById("subTotalDisplay").innerText.replace(/\./g,'').replace('₫',''); const sub = parseInt(subText) || 0; updateTotal(sub, fee); }
        function updateTotal(sub, ship) {
            document.getElementById("subTotalDisplay").innerText = new Intl.NumberFormat('vi-VN').format(sub) + '₫';
            document.getElementById("shippingDisplay").innerText = new Intl.NumberFormat('vi-VN').format(ship) + '₫';
            document.getElementById("finalTotalDisplay").innerText = new Intl.NumberFormat('vi-VN').format(sub + ship) + '₫';
            if(document.querySelector('input[name="payment"]:checked')?.value === 'banking') { updateQRCode(); }
        }
        function checkFormProgress() {
            const fields = ['cusName', 'cusPhone', 'selProvince', 'selCommune', 'cusAddress']; let filled = 0;
            fields.forEach(id => { const el = document.getElementById(id); if(el && el.value.trim() !== '') { filled++; if(id !== 'selCommune') el.classList.remove('error-input', 'error-shake'); else document.getElementById('searchCommune').classList.remove('error-input', 'error-shake'); } });
            const pct = (filled / fields.length) * 100; document.getElementById('progressBar').style.width = pct + '%'; document.getElementById('progressBar').className = `h-2 rounded-full transition-all duration-500 ease-out ${pct === 100 ? 'bg-green-500' : 'bg-[#ee4d2d]'}`; document.getElementById('progressText').innerText = `${filled}/${fields.length} Hoàn thành`; document.getElementById('progressText').className = `text-xs font-bold ${pct === 100 ? 'text-green-600' : 'text-[#ee4d2d]'}`;
        }

        // --- CẬP NHẬT HÀM GỬI ĐƠN HÀNG LÊN FIREBASE ---
        function submitOrder() {
            // 1. Validate Form
            document.querySelectorAll("[id^='err']").forEach(e => e.classList.add("hidden"));
            const method = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;
            
            // Chuẩn bị dữ liệu đơn hàng
            let orderData = {
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'new', // new, shipping, done, cancel
                method: method,
                paymentMethod: payment,
                total: parseInt(document.getElementById("finalTotalDisplay").innerText.replace(/\./g,'').replace('₫','')) || 0,
                items: cartItems, // Danh sách sản phẩm trong giỏ
                shippingFee: method === 'home' ? 30000 : 0
            };

            let hasError = false;
            let errorFields = [];

            if(method === 'home') {
                const name = document.getElementById("cusName");
                const phone = document.getElementById("cusPhone");
                const provEl = document.getElementById("selProvince");
                const commEl = document.getElementById("selCommune");
                const searchComm = document.getElementById("searchCommune");
                const addr = document.getElementById("cusAddress");
                const note = document.getElementById("cusNote");

                if(!name.value.trim()) { errorFields.push(name); hasError=true; }
                if(!phone.value.trim()) { errorFields.push(phone); hasError=true; }
                if(!provEl.value) { errorFields.push(provEl); hasError=true; }
                if(!commEl.value) { errorFields.push(searchComm); hasError=true; }
                if(!addr.value.trim()) { errorFields.push(addr); hasError=true; }

                if(!hasError) {
                    // Lấy text hiển thị của Tỉnh/Xã
                    const provText = provEl.options[provEl.selectedIndex]?.text || "";
                    const commText = searchComm.value || ""; // Lấy từ ô input search
                    
                    orderData.customer = {
                        name: name.value,
                        phone: phone.value,
                        fullAddress: `${addr.value}, ${commText}, ${provText}`,
                        note: note.value
                    };
                }
            } else {
                const info = document.getElementById("storeCusInfo");
                if(!info.value.trim()) { errorFields.push(info); hasError=true; }
                else {
                    orderData.customer = { name: info.value, type: "Nhận tại cửa hàng", fullAddress: "Nhận tại shop" };
                }
            }

            if(hasError) {
                errorFields.forEach(el => {
                    el.classList.add('error-input', 'error-shake');
                    setTimeout(() => el.classList.remove('error-shake'), 500);
                });
                showValidationModal(["Vui lòng điền đầy đủ thông tin nhận hàng."]);
                return;
            }

            // 2. Gửi lên Firebase
            const btn = document.getElementById("btnOrder");
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-xl"></i> &nbsp; ĐANG GỬI ĐƠN...';
            btn.classList.add('bg-gray-400', 'cursor-not-allowed');
            btn.classList.remove('bg-[#ee4d2d]', 'hover:bg-[#d73211]');
            btn.disabled = true;

            db.collection("orders").add(orderData).then((docRef) => {
                console.log("Order written with ID: ", docRef.id);
                
                let successMsg = "🎉 Đặt hàng thành công! Mã đơn: " + docRef.id.slice(-6).toUpperCase();
                if(payment === 'banking') {
                    successMsg = "🎉 Đã tạo đơn! Vui lòng hoàn tất chuyển khoản.";
                }

                btn.innerHTML = `<i class="fa-solid fa-check"></i> THÀNH CÔNG`;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600');

                setTimeout(() => {
                    alert(successMsg);
                    // Reset
                    cartItems = [];
                    saveCart();
                    updateCartBadge(0);
                    closeCheckout();
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                    btn.classList.add('bg-[#ee4d2d]', 'hover:bg-[#d73211]');
                    btn.classList.remove('bg-green-600');
                }, 1000);

            }).catch((error) => {
                console.error("Error adding document: ", error);
                alert("Lỗi hệ thống! Vui lòng chụp ảnh giỏ hàng và gửi Zalo cho shop.");
                btn.innerHTML = originalContent;
                btn.classList.add('bg-[#ee4d2d]', 'hover:bg-[#d73211]');
                btn.classList.remove('bg-gray-400');
                btn.disabled = false;
            });
        }

        function showValidationModal(errors) {
            const list = document.getElementById("errorList"); list.innerHTML = "";
            errors.forEach((err, index) => { const li = document.createElement("li"); li.className = "flex items-center gap-2 slide-in-item"; li.style.animationDelay = `${index * 0.1}s`; li.innerHTML = `<i class="fa-solid fa-xmark text-red-500"></i> ${err}`; list.appendChild(li); });
            const modal = document.getElementById("validationModal"); modal.classList.remove("hidden"); requestAnimationFrame(() => { modal.classList.remove("opacity-0"); document.getElementById("validationContent").classList.remove("scale-95"); document.getElementById("validationContent").classList.add("scale-100"); });
        }
        function closeValidationModal() { const modal = document.getElementById("validationModal"); modal.classList.add("opacity-0"); document.getElementById("validationContent").classList.remove("scale-100"); document.getElementById("validationContent").classList.add("scale-95"); setTimeout(() => modal.classList.add("hidden"), 200); }
        function loadProvinces() {
            const sel = document.getElementById("selProvince"); if (typeof vietnamLocations !== 'undefined') { vietnamLocations.forEach(p => { const opt = document.createElement("option"); opt.value = p.id; opt.text = p.name; sel.add(opt); }); }
        }
        function handleProvinceChange() {
            const pid = document.getElementById("selProvince").value; const searchInput = document.getElementById("searchCommune"); const hiddenInput = document.getElementById("selCommune"); const clearBtn = document.getElementById("clearCommuneBtn");
            searchInput.value = ""; hiddenInput.value = ""; clearBtn.classList.add("hidden"); document.getElementById("communeDropdown").classList.add("hidden");
            if(!pid) { searchInput.disabled = true; searchInput.placeholder = "-- Chọn Tỉnh trước --"; } else { searchInput.disabled = false; searchInput.placeholder = "Gõ tên Phường/Xã (VD: Phúc Xá)..."; } checkFormProgress();
        }
        function clearCommuneSearch() {
            const searchInput = document.getElementById("searchCommune"); const hiddenInput = document.getElementById("selCommune"); const clearBtn = document.getElementById("clearCommuneBtn");
            searchInput.value = ""; hiddenInput.value = ""; searchInput.focus(); clearBtn.classList.add("hidden"); checkFormProgress(); filterCommunes("");
        }
        function setupCommuneSearch() {
            const searchInput = document.getElementById("searchCommune"); const clearBtn = document.getElementById("clearCommuneBtn");
            searchInput.addEventListener("focus", function() { if(!this.disabled) filterCommunes(this.value); });
            searchInput.addEventListener("input", function() { if(this.value.length > 0) clearBtn.classList.remove("hidden"); else clearBtn.classList.add("hidden"); filterCommunes(this.value); });
        }
        function filterCommunes(query) {
            const pid = document.getElementById("selProvince").value; if (!pid) return; const prov = vietnamLocations.find(p => p.id === pid); if (!prov || !prov.communes) return;
            const dropdown = document.getElementById("communeDropdown"); const normalizedQuery = query.toLowerCase().trim();
            const filtered = prov.communes.filter(c => c.name.toLowerCase().includes(normalizedQuery) || c.zone_hint.toLowerCase().includes(normalizedQuery)); const displayList = filtered.slice(0, 20);
            dropdown.innerHTML = "";
            if (displayList.length === 0) { dropdown.innerHTML = `<div class="p-3 text-sm text-gray-500 text-center">Không tìm thấy kết quả</div>`; } else {
                displayList.forEach(c => {
                    const div = document.createElement("div"); div.className = "commune-option p-2 cursor-pointer text-sm border-b last:border-0 transition-colors flex justify-between items-center";
                    let nameDisplay = c.name; let hintDisplay = c.zone_hint;
                    if(normalizedQuery && nameDisplay.toLowerCase().includes(normalizedQuery)) { nameDisplay = nameDisplay.replace(new RegExp(normalizedQuery, "gi"), (match) => `<span class="bg-yellow-100 font-bold">${match}</span>`); }
                    if(normalizedQuery && hintDisplay.toLowerCase().includes(normalizedQuery)) { hintDisplay = hintDisplay.replace(new RegExp(normalizedQuery, "gi"), (match) => `<span class="bg-yellow-100 font-bold">${match}</span>`); }
                    div.innerHTML = `<span class="font-medium text-gray-700">${nameDisplay}</span><span class="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${hintDisplay}</span>`; div.onclick = () => selectCommune(c); dropdown.appendChild(div);
                });
            } dropdown.classList.remove("hidden");
        }
        function selectCommune(c) {
            const searchInput = document.getElementById("searchCommune"); const hiddenInput = document.getElementById("selCommune"); const dropdown = document.getElementById("communeDropdown"); const clearBtn = document.getElementById("clearCommuneBtn");
            searchInput.value = `${c.name} - ${c.zone_hint}`; hiddenInput.value = c.id; dropdown.classList.add("hidden"); clearBtn.classList.remove("hidden"); searchInput.classList.remove('error-input', 'error-shake'); checkFormProgress();
        }
    </script>
</body>
</html>
