<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilkFlower Studio — Hoa lụa cao cấp</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
    .serif { font-family: 'Playfair Display', serif; }
    .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); }
    .cart-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .product-card:hover img { transform: scale(1.05); }
    .toast-pop { animation: slideUp 0.4s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .no-scroll { overflow: hidden; }
  </style>
</head>

<body class="bg-[#faf9f6] text-slate-900">
  <div id="toastHost" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[9999] space-y-2"></div>

  <nav class="glass-nav sticky top-0 z-50 border-b border-slate-100">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="#/" class="text-2xl font-bold serif italic tracking-tighter">SilkFlower</a>
      
      <div class="hidden md:flex space-x-8 text-[11px] uppercase tracking-[0.2em] font-bold">
        <a href="#/" class="hover:text-indigo-600 transition">Trang chủ</a>
        <a href="#/shop" class="hover:text-indigo-600 transition">Cửa hàng</a>
        <a href="#/policy" class="hover:text-indigo-600 transition">Chính sách</a>
      </div>

      <div class="flex items-center gap-4">
        <button id="btnCart" class="relative p-2">
          <i class="fa-solid fa-bag-shopping text-xl"></i>
          <span id="cartBadge" class="hidden absolute -top-1 -right-1 bg-indigo-600 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full">0</span>
        </button>
        <a href="admin.html" class="text-xs bg-black text-white px-4 py-2 rounded-full font-bold">ADMIN</a>
      </div>
    </div>
  </nav>

  <main>
    <section id="view-hero" class="relative h-[70vh] flex items-center justify-center overflow-hidden">
      <img src="https://images.unsplash.com/photo-1487070183336-b863922373d4?auto=format&fit=crop&q=80&w=2000" class="absolute inset-0 w-full h-full object-cover" alt="Hero">
      <div class="absolute inset-0 bg-black/30"></div>
      <div class="relative text-center text-white p-6 space-y-6">
        <h1 class="text-5xl md:text-7xl serif">Vẻ đẹp vĩnh cửu</h1>
        <p class="max-w-md mx-auto text-sm font-light tracking-widest uppercase">Hoa lụa thiết kế cao cấp cho không gian sống</p>
        <a href="#/shop" class="inline-block bg-white text-black px-12 py-4 rounded-full font-bold text-xs tracking-[0.3em] uppercase hover:bg-black hover:text-white transition">Khám phá ngay</a>
      </div>
    </section>

    <section id="view-shop" class="hidden max-w-7xl mx-auto px-4 py-16">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-12">
        <div>
          <h2 class="text-4xl serif">Cửa hàng</h2>
          <p class="text-slate-500 mt-2">Tìm mẫu hoa ưng ý nhất cho bạn</p>
        </div>
        <div class="flex flex-wrap gap-3 w-full md:w-auto">
          <input id="qSearch" class="flex-1 md:w-64 bg-white border border-slate-200 rounded-2xl px-5 py-3 text-sm outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Tìm tên hoa...">
          <select id="qCategory" class="bg-white border border-slate-200 rounded-2xl px-5 py-3 text-sm outline-none">
            <option value="">Tất cả danh mục</option>
          </select>
        </div>
      </div>
      
      <div id="shopLoading" class="text-center py-20 text-slate-400">Đang đồng bộ kho hàng...</div>
      <div id="productGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <section id="view-product" class="hidden max-w-7xl mx-auto px-4 py-16">
        <div id="productDetail" class="grid grid-cols-1 md:grid-cols-2 gap-12"></div>
    </section>

    <section id="view-checkout" class="hidden max-w-4xl mx-auto px-4 py-16">
        <h2 class="text-3xl serif mb-8">Thanh toán</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 space-y-4">
                    <h3 class="font-bold">Thông tin giao hàng</h3>
                    <input id="fName" class="w-full bg-slate-50 rounded-xl p-4 text-sm outline-none" placeholder="Họ và tên *">
                    <input id="fPhone" class="w-full bg-slate-50 rounded-xl p-4 text-sm outline-none" placeholder="Số điện thoại *">
                    <textarea id="fAddress" class="w-full bg-slate-50 rounded-xl p-4 text-sm outline-none" placeholder="Địa chỉ giao hàng *"></textarea>
                </div>
                <button id="btnPlaceOrder" class="w-full bg-black text-white py-5 rounded-2xl font-bold shadow-xl hover:bg-slate-800 transition">XÁC NHẬN ĐẶT HÀNG</button>
            </div>
            <div id="checkoutSummary" class="bg-indigo-50/50 p-8 rounded-[2.5rem] h-fit"></div>
        </div>
    </section>

    <section id="view-thanks" class="hidden py-20 text-center space-y-6">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-3xl"><i class="fa-solid fa-check"></i></div>
        <h2 class="text-4xl serif">Cảm ơn bạn!</h2>
        <p class="text-slate-500">Đơn hàng của bạn đã được tiếp nhận thành công.</p>
        <div id="thankOrderCode" class="text-xl font-mono font-bold"></div>
        <a href="#/shop" class="inline-block bg-black text-white px-10 py-4 rounded-full font-bold uppercase text-xs">Tiếp tục mua sắm</a>
    </section>
  </main>

  <div id="cartBackdrop" class="fixed inset-0 bg-black/40 z-[100] hidden backdrop-blur-sm"></div>
  <aside id="cartDrawer" class="cart-drawer fixed top-0 right-0 h-full w-full max-w-md bg-white z-[110] shadow-2xl translate-x-full flex flex-col">
    <div class="p-6 border-b flex justify-between items-center">
      <h3 class="text-xl font-bold">Giỏ hàng</h3>
      <button id="btnCloseCart" class="text-2xl">✕</button>
    </div>
    <div id="cartItems" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
    <div class="p-6 border-t bg-slate-50 space-y-4">
      <div class="flex justify-between font-bold text-lg"><span>Tổng cộng:</span><span id="cartTotal">0 đ</span></div>
      <button id="btnCheckout" class="w-full bg-black text-white py-4 rounded-2xl font-bold">TIẾN HÀNH THANH TOÁN</button>
    </div>
  </aside>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDT0IEKhjAJZ_ZiMVwVCvO-fuj0ByReoE8",
      authDomain: "esomar-vnn.firebaseapp.com",
      projectId: "esomar-vnn",
      storageBucket: "esomar-vnn.firebasestorage.app",
      messagingSenderId: "1023271897973",
      appId: "1:1023271897973:web:c7207b0e8321fc271fe13c"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, where, orderBy, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const el = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat('vi-VN').format(n) + ' đ';

    let cart = JSON.parse(localStorage.getItem('sf_cart') || '[]');
    let currentUID = null;

    // TOAST
    function showToast(msg) {
        const t = document.createElement('div');
        t.className = "toast-pop bg-black text-white px-8 py-4 rounded-full shadow-2xl font-bold text-sm";
        t.innerText = msg;
        el('toastHost').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // AUTH
    onAuthStateChanged(auth, (u) => { 
        if (u) currentUID = u.uid; 
        else signInAnonymously(auth); 
    });

    // DYNAMIC CATEGORIES
    onSnapshot(collection(db, "categories"), (snap) => {
        const select = el('qCategory');
        select.innerHTML = '<option value="">Tất cả danh mục</option>';
        snap.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
        });
    });

    // LOAD PRODUCTS
    onSnapshot(query(collection(db, "products"), where("active", "==", true), orderBy("createdAt", "desc")), (snap) => {
        el('shopLoading').classList.add('hidden');
        renderShop(snap);
    });

    function renderShop(snap) {
        const grid = el('productGrid');
        grid.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            const id = d.id;
            grid.innerHTML += `
                <div class="product-card group cursor-pointer" onclick="location.hash='#/product/${id}'">
                    <div class="aspect-[4/5] rounded-[2rem] overflow-hidden bg-white mb-4">
                        <img src="${p.images?.[0] || ''}" class="w-full h-full object-cover transition duration-500">
                    </div>
                    <p class="text-[10px] font-black uppercase text-indigo-500 tracking-widest">${p.category}</p>
                    <h4 class="font-bold text-lg truncate">${p.name}</h4>
                    <p class="font-black text-indigo-600">${fmt(p.basePrice)}</p>
                </div>`;
        });
    }

    // CART LOGIC
    window.updateCart = () => {
        localStorage.setItem('sf_cart', JSON.stringify(cart));
        el('cartBadge').innerText = cart.length;
        el('cartBadge').classList.toggle('hidden', cart.length === 0);
        renderCart();
    };

    function renderCart() {
        const host = el('cartItems');
        host.innerHTML = cart.length ? "" : '<p class="text-center text-slate-400 py-10">Giỏ hàng đang trống</p>';
        let total = 0;
        cart.forEach((item, index) => {
            total += item.price;
            host.innerHTML += `
                <div class="flex gap-4 items-center">
                    <img src="${item.img}" class="w-16 h-16 rounded-xl object-cover">
                    <div class="flex-1"><h5 class="font-bold text-sm">${item.name}</h5><p class="text-xs text-indigo-600">${fmt(item.price)}</p></div>
                    <button onclick="removeItem(${index})" class="text-slate-300 hover:text-red-500">✕</button>
                </div>`;
        });
        el('cartTotal').innerText = fmt(total);
    }

    window.removeItem = (idx) => { cart.splice(idx, 1); updateCart(); };

    // ROUTING
    const route = async () => {
        const hash = location.hash || '#/';
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        
        if (hash === '#/') el('view-hero').classList.remove('hidden');
        else if (hash === '#/shop') el('view-shop').classList.remove('hidden');
        else if (hash === '#/checkout') { renderCheckout(); el('view-checkout').classList.remove('hidden'); }
        else if (hash === '#/thanks') el('view-thanks').classList.remove('hidden');
        else if (hash.startsWith('#/product/')) {
            const id = hash.split('/')[2];
            renderProductDetail(id);
            el('view-product').classList.remove('hidden');
        }
        window.scrollTo(0,0);
    };

    async function renderProductDetail(id) {
        const s = await getDoc(doc(db, "products", id));
        if (!s.exists()) return;
        const p = s.data();
        el('productDetail').innerHTML = `
            <div class="rounded-[3rem] overflow-hidden"><img src="${p.images?.[0]}" class="w-full"></div>
            <div class="space-y-6">
                <span class="bg-indigo-50 text-indigo-600 px-4 py-1 rounded-full text-xs font-bold uppercase">${p.category}</span>
                <h2 class="text-4xl serif">${p.name}</h2>
                <p class="text-3xl font-black text-indigo-600">${fmt(p.basePrice)}</p>
                <button onclick="addToCart('${id}', '${p.name}', ${p.basePrice}, '${p.images?.[0]}')" class="w-full bg-black text-white py-5 rounded-2xl font-bold shadow-xl">THÊM VÀO GIỎ HÀNG</button>
                <div class="pt-6 border-t text-sm text-slate-500 leading-relaxed">${p.description || 'Sản phẩm thủ công tinh xảo, chất liệu lụa cao cấp.'}</div>
            </div>`;
    }

    window.addToCart = (id, name, price, img) => {
        cart.push({ id, name, price, img });
        updateCart();
        showToast("Đã thêm vào giỏ hàng!");
    };

    function renderCheckout() {
        let total = 0;
        let html = '<h3 class="font-bold mb-4">Tóm tắt đơn hàng</h3><div class="space-y-3">';
        cart.forEach(item => {
            total += item.price;
            html += `<div class="flex justify-between text-sm"><span>${item.name}</span><span class="font-bold">${fmt(item.price)}</span></div>`;
        });
        html += `</div><div class="border-t mt-4 pt-4 flex justify-between font-black text-xl"><span>Tổng tiền</span><span>${fmt(total)}</span></div>`;
        el('checkoutSummary').innerHTML = html;
    }

    // PLACE ORDER
    el('btnPlaceOrder').onclick = async () => {
        if (!el('fName').value || !el('fPhone').value || !el('fAddress').value) return showToast("Vui lòng điền đủ thông tin!");
        
        const orderData = {
            uid: currentUID,
            customerName: el('fName').value,
            customerPhone: el('fPhone').value,
            address: el('fAddress').value,
            items: cart,
            totals: { total: cart.reduce((a,b) => a + b.price, 0) },
            status: "new",
            createdAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, "orders"), orderData);
        el('thankOrderCode').innerText = `Mã đơn: #${docRef.id.slice(0,8).toUpperCase()}`;
        cart = []; updateCart();
        location.hash = "#/thanks";
    };

    // UI Events
    el('btnCart').onclick = () => { el('cartBackdrop').classList.remove('hidden'); el('cartDrawer').classList.remove('translate-x-full'); document.body.classList.add('no-scroll'); };
    el('btnCloseCart').onclick = () => { el('cartBackdrop').classList.add('hidden'); el('cartDrawer').classList.add('translate-x-full'); document.body.classList.remove('no-scroll'); };
    el('btnCheckout').onclick = () => { if(!cart.length) return showToast("Giỏ hàng đang trống!"); el('btnCloseCart').click(); location.hash = "#/checkout"; };

    window.addEventListener('hashchange', route);
    window.onload = () => { route(); updateCart(); };
  </script>
</body>
</html>
