<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SilkFlower Studio — Intelligent Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
    .btn-active { background: #000 !important; color: #fff !important; }
    .toast-animate { animation: slideIn 0.3s ease-out forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .loading-shimmer { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  </style>
</head>

<body class="text-slate-800">
  <div id="toastContainer" class="fixed top-5 right-5 z-[200] space-y-3"></div>

  <div class="flex min-h-screen">
    <aside class="w-64 bg-white border-r border-slate-200 hidden lg:flex flex-col p-6 sticky top-0 h-screen">
      <div class="text-2xl font-bold tracking-tighter mb-10 flex items-center gap-2">
        <i class="fa-solid fa-wand-magic-sparkles text-indigo-600"></i>
        <span>SILKFLOWER</span>
      </div>
      
      <nav class="space-y-2 flex-1">
        <button class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition btn-active" data-tab="dashboard">
          <i class="fa-solid fa-chart-pie w-5"></i> Tổng quan
        </button>
        <button class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition" data-tab="orders">
          <i class="fa-solid fa-box w-5"></i> Đơn hàng
        </button>
        <button class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition" data-tab="products">
          <i class="fa-solid fa-leaf w-5"></i> Sản phẩm
        </button>
        <button class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition" data-tab="vouchers">
          <i class="fa-solid fa-ticket w-5"></i> Vouchers
        </button>
      </nav>

      <div class="pt-6 border-t border-slate-100">
        <button id="btnSignOut" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 transition">
          <i class="fa-solid fa-right-from-bracket w-5"></i> Đăng xuất
        </button>
      </div>
    </aside>

    <main class="flex-1 p-4 lg:p-10">
      <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-10">
        <div>
          <h1 id="pageTitle" class="text-2xl font-bold">Tổng quan hệ thống</h1>
          <p class="text-slate-500 text-sm" id="whoami"></p>
        </div>
        <div id="uidBox" class="text-[10px] font-mono bg-slate-100 px-3 py-1 rounded-full text-slate-400">UID: ---</div>
      </header>

      <section id="tab-dashboard" class="tab-content space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="glass-card p-6 rounded-3xl">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-indigo-50 text-indigo-600 rounded-2xl"><i class="fa-solid fa-cart-shopping text-xl"></i></div>
              <span class="text-xs font-bold text-emerald-500">+12% vs tháng trước</span>
            </div>
            <div class="text-sm text-slate-500 font-medium">Tổng đơn hàng</div>
            <div class="text-3xl font-bold mt-1" id="stat-orders">0</div>
          </div>
          <div class="glass-card p-6 rounded-3xl">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-rose-50 text-rose-600 rounded-2xl"><i class="fa-solid fa-layer-group text-xl"></i></div>
            </div>
            <div class="text-sm text-slate-500 font-medium">Sản phẩm hiện có</div>
            <div class="text-3xl font-bold mt-1" id="stat-products">0</div>
          </div>
          <div class="glass-card p-6 rounded-3xl">
            <div class="flex justify-between items-start mb-4">
              <div class="p-3 bg-amber-50 text-amber-600 rounded-2xl"><i class="fa-solid fa-tags text-xl"></i></div>
            </div>
            <div class="text-sm text-slate-500 font-medium">Vouchers đang chạy</div>
            <div class="text-3xl font-bold mt-1" id="stat-vouchers">0</div>
          </div>
        </div>
        
        <div class="bg-indigo-600 p-8 rounded-[2rem] text-white flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold mb-2">Trợ lý AI đang sẵn sàng ✨</h3>
            <p class="text-indigo-100 text-sm max-w-md">Hệ thống đang theo dõi xu hướng mua hàng của khách. Hãy thêm ảnh sản phẩm chất lượng cao để tăng 40% tỉ lệ chuyển đổi.</p>
          </div>
          <button class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-2xl text-sm font-bold backdrop-blur-md">Xem gợi ý</button>
        </div>
      </section>

      <section id="tab-products" class="tab-content hidden space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">Kho hàng thông minh</h2>
          <button id="btnNewProduct" class="bg-black text-white px-6 py-3 rounded-2xl font-bold text-sm hover:scale-105 transition active:scale-95 flex items-center gap-2">
            <i class="fa-solid fa-plus"></i> Thêm sản phẩm mới
          </button>
        </div>
        <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <div class="loading-shimmer h-48 rounded-3xl"></div>
          <div class="loading-shimmer h-48 rounded-3xl"></div>
        </div>
      </section>

      <section id="tab-orders" class="tab-content hidden"><div class="glass-card p-10 rounded-3xl text-center">Chức năng Đơn hàng đang đồng bộ...</div></section>
      <section id="tab-vouchers" class="tab-content hidden"><div class="glass-card p-10 rounded-3xl text-center">Chức năng Voucher đang đồng bộ...</div></section>
    </main>
  </div>

  <div id="authOverlay" class="fixed inset-0 bg-white z-[300] flex items-center justify-center p-6 hidden">
    <div class="w-full max-w-md space-y-8">
      <div class="text-center">
        <h2 class="text-4xl font-black tracking-tighter">SILKFLOWER</h2>
        <p class="text-slate-500 mt-2">Hệ thống quản trị trung tâm</p>
      </div>
      <div class="space-y-4">
        <input id="aEmail" class="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Email admin">
        <input id="aPass" type="password" class="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Mật khẩu">
        <button id="btnSignIn" class="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg hover:shadow-xl transition">ĐĂNG NHẬP</button>
        <button id="btnSignUp" class="w-full text-slate-400 text-sm hover:text-black transition">Tạo tài khoản quản trị mới</button>
      </div>
    </div>
  </div>

  <div id="pmModal" class="fixed inset-0 bg-black/60 z-[400] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-[2.5rem] w-full max-w-2xl p-8 shadow-2xl space-y-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center">
        <h3 class="text-2xl font-bold">Cập nhật sản phẩm</h3>
        <button onclick="el('pmModal').classList.add('hidden')" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 transition">✕</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-4">
          <label class="block">
            <span class="text-xs font-bold text-slate-400 uppercase">Tên sản phẩm</span>
            <input id="pmName" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500" placeholder="VD: Hoa Hồng Sáp">
          </label>
          <label class="block">
            <span class="text-xs font-bold text-slate-400 uppercase">Giá bán (VND)</span>
            <input id="pmPrice" type="number" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500" placeholder="350000">
          </label>
          <label class="block">
            <span class="text-xs font-bold text-slate-400 uppercase">Danh mục</span>
            <select id="pmCategory" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none">
              <option value="bo-hoa">Bó hoa</option>
              <option value="gio-hoa">Giỏ hoa</option>
              <option value="binh-hoa">Bình hoa</option>
            </select>
          </label>
        </div>
        <div class="space-y-4">
          <label class="block">
            <span class="text-xs font-bold text-slate-400 uppercase">Link ảnh sản phẩm</span>
            <textarea id="pmImages" rows="4" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none text-xs" placeholder="https://..."></textarea>
          </label>
          <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
            <input type="checkbox" id="pmActive" class="w-5 h-5 accent-indigo-600" checked>
            <span class="text-sm font-medium">Kích hoạt hiển thị lên cửa hàng</span>
          </div>
        </div>
      </div>
      <button id="btnSaveProduct" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition">XÁC NHẬN LƯU</button>
    </div>
  </div>

  <script type="module">
    // --- FIREBASE CONFIG (DỰ ÁN: esomar-vnn) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDT0IEKhjAJZ_ZiMVwVCvO-fuj0ByReoE8",
      authDomain: "esomar-vnn.firebaseapp.com",
      projectId: "esomar-vnn",
      storageBucket: "esomar-vnn.firebasestorage.app",
      messagingSenderId: "1023271897973",
      appId: "1:1023271897973:web:c7207b0e8321fc271fe13c"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const el = (id) => document.getElementById(id);

    // THÔNG BÁO THÔNG MINH
    function showToast(type, msg) {
      const container = el('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast-animate flex items-center gap-3 px-6 py-4 rounded-2xl shadow-xl text-white font-bold text-sm ${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`;
      toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-circle-exclamation'}"></i> ${msg}`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // TAB NAVIGATION
    const tabs = document.querySelectorAll(".tab-btn");
    tabs.forEach(t => {
      t.onclick = () => {
        const target = t.dataset.tab;
        tabs.forEach(btn => btn.classList.remove('btn-active'));
        t.classList.add('btn-active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        el(`tab-${target}`).classList.remove('hidden');
        el('pageTitle').innerText = t.innerText;
        if(target === 'products') loadProducts();
        if(target === 'dashboard') loadStats();
      };
    });

    // LOAD THỐNG KÊ (SMART METRICS)
    async function loadStats() {
      const pSnap = await getDocs(collection(db, "products"));
      const oSnap = await getDocs(collection(db, "orders"));
      const vSnap = await getDocs(collection(db, "vouchers"));
      el('stat-products').innerText = pSnap.size;
      el('stat-orders').innerText = oSnap.size;
      el('stat-vouchers').innerText = vSnap.size;
    }

    // QUẢN LÝ SẢN PHẨM (Nâng cấp Xoá/Sửa)
    async function loadProducts() {
      const grid = el('productsGrid');
      grid.innerHTML = `<div class="loading-shimmer h-48 rounded-3xl col-span-full"></div>`;
      const snap = await getDocs(collection(db, "products"));
      grid.innerHTML = "";
      
      snap.forEach(d => {
        const p = d.data();
        const id = d.id;
        const card = document.createElement('div');
        card.className = "glass-card p-5 rounded-[2rem] hover:shadow-xl transition group relative overflow-hidden";
        card.innerHTML = `
          <div class="flex gap-4">
            <img src="${p.images?.[0] || 'https://placehold.co/100x100?text=No+Image'}" class="w-24 h-24 rounded-2xl object-cover bg-slate-100">
            <div class="flex-1">
              <span class="text-[10px] font-black uppercase text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md">${p.category}</span>
              <h4 class="font-bold text-lg mt-1 truncate">${p.name}</h4>
              <p class="text-indigo-600 font-black">${new Intl.NumberFormat('vi-VN').format(p.basePrice)} đ</p>
              <div class="mt-3 flex gap-2">
                <button onclick="editProduct('${id}')" class="text-xs bg-slate-100 hover:bg-black hover:text-white px-4 py-2 rounded-xl transition font-bold">SỬA</button>
                <button onclick="deleteProduct('${id}')" class="text-xs bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white px-4 py-2 rounded-xl transition font-bold">XOÁ</button>
              </div>
            </div>
          </div>
          <div class="absolute top-4 right-4 h-2 w-2 rounded-full ${p.active ? 'bg-emerald-500' : 'bg-slate-300'}"></div>
        `;
        grid.appendChild(card);
      });
    }

    // HÀM XOÁ (CÓ XÁC NHẬN)
    window.deleteProduct = async (id) => {
      if(confirm("Xác nhận xoá vĩnh viễn sản phẩm này?")) {
        try {
          await deleteDoc(doc(db, "products", id));
          showToast('success', 'Đã xoá sản phẩm thành công!');
          loadProducts();
          loadStats();
        } catch(e) { showToast('error', 'Lỗi khi xoá!'); }
      }
    };

    // HÀM SỬA
    window.editProduct = async (id) => {
      const snap = await getDoc(doc(db, "products", id));
      if(snap.exists()) {
        const p = snap.data();
        el('pmName').value = p.name;
        el('pmPrice').value = p.basePrice;
        el('pmCategory').value = p.category;
        el('pmImages').value = (p.images || []).join('\n');
        el('pmActive').checked = p.active;
        el('pmModal').classList.remove('hidden');
        el('btnSaveProduct').onclick = async () => {
           await setDoc(doc(db, "products", id), {
              name: el('pmName').value,
              basePrice: Number(el('pmPrice').value),
              category: el('pmCategory').value,
              images: el('pmImages').value.split('\n').filter(l => l),
              active: el('pmActive').checked,
              updatedAt: serverTimestamp()
           }, {merge: true});
           el('pmModal').classList.add('hidden');
           showToast('success', 'Cập nhật thành công!');
           loadProducts();
        };
      }
    };

    el('btnNewProduct').onclick = () => {
        el('pmName').value = ''; el('pmPrice').value = '';
        el('pmModal').classList.remove('hidden');
        el('btnSaveProduct').onclick = async () => {
            const price = Number(el('pmPrice').value);
            if(isNaN(price) || price <= 0) { showToast('error', 'Giá tiền không hợp lệ!'); return; }
            await addDoc(collection(db, "products"), {
                name: el('pmName').value,
                basePrice: price,
                category: el('pmCategory').value,
                images: el('pmImages').value.split('\n').filter(l => l),
                active: el('pmActive').checked,
                createdAt: serverTimestamp()
            });
            el('pmModal').classList.add('hidden');
            showToast('success', 'Thêm sản phẩm mới thành công!');
            loadProducts();
            loadStats();
        };
    };

    // LOGIN LOGIC
    el('btnSignIn').onclick = () => signInWithEmailAndPassword(auth, el('aEmail').value, el('aPass').value).catch(e => showToast('error', 'Sai thông tin đăng nhập!'));
    el('btnSignUp').onclick = () => createUserWithEmailAndPassword(auth, el('aEmail').value, el('aPass').value).then(() => showToast('success', 'Tạo tài khoản thành công!'));
    el('btnSignOut').onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (u) => {
      if (u) {
        el('authOverlay').classList.add('hidden');
        el('uidBox').innerText = `UID: ${u.uid}`;
        el('whoami').innerText = u.email;
        const adminSnap = await getDoc(doc(db, "admins", u.uid));
        if (adminSnap.exists()) {
          el('adminWarn').classList.add('hidden');
          loadStats();
        } else {
          el('adminWarn').classList.remove('hidden');
          showToast('error', 'Bạn chưa có quyền Admin!');
        }
      } else {
        el('authOverlay').classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
