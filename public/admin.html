<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K√™nh Ng∆∞·ªùi B√°n - MimiFlower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .active-nav { background-color: #fff1f2; color: #ee4d2d; border-right: 3px solid #ee4d2d; font-weight: bold; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #ee4d2d; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Responsive Table to Cards */
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-card { display: block; border-bottom: 1px solid #e5e7eb; padding: 12px; background: white; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .desktop-table { display: none; }
        }
        @media (min-width: 769px) {
            .mobile-card { display: none; }
            .desktop-table { display: table; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800">

    <!-- 1. LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#ee4d2d]">
                    <i class="fa-solid fa-store text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">K√™nh Ng∆∞·ªùi B√°n</h2>
                <p class="text-gray-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω MimiFlower</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">T√†i kho·∫£n</label>
                    <input type="text" id="username" class="w-full border p-2.5 rounded focus:border-[#ee4d2d] outline-none mt-1" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full border p-2.5 rounded focus:border-[#ee4d2d] outline-none mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-[#ee4d2d] text-white py-2.5 rounded font-bold hover:bg-[#d73211] transition shadow-lg shadow-orange-500/30">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <!-- 2. SIDEBAR -->
    <div class="w-64 bg-white border-r border-gray-200 flex-col hidden md:flex z-20">
        <div class="p-4 border-b border-gray-100 flex items-center gap-2">
            <i class="fa-solid fa-leaf text-[#ee4d2d] text-xl"></i>
            <span class="font-bold text-xl tracking-tight text-gray-800">MimiManager</span>
        </div>
        <nav class="flex-1 py-4 space-y-1">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition active-nav">
                <i class="fa-solid fa-chart-line w-5 text-center"></i> T·ªïng Quan
            </a>
            <a href="#" onclick="switchTab('orders')" id="nav-orders" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition">
                <i class="fa-solid fa-clipboard-list w-5 text-center"></i> ƒê∆°n H√†ng 
                <span id="badgeNewOrders" class="hidden ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
            </a>
            <a href="#" onclick="switchTab('products')" id="nav-products" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition">
                <i class="fa-solid fa-box w-5 text-center"></i> S·∫£n Ph·∫©m
            </a>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-user"></i></div>
                <div class="text-sm">
                    <div class="font-bold text-gray-800">Admin</div>
                    <div class="text-xs text-gray-500">Ch·ªß Shop</div>
                </div>
            </div>
            <button onclick="logout()" class="flex items-center gap-2 text-red-500 hover:text-red-700 text-sm w-full px-2">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 left-0 right-0 h-14 bg-white border-b border-gray-200 z-30 flex items-center justify-between px-4 shadow-sm">
        <span class="font-bold text-lg text-[#ee4d2d] flex items-center gap-2"><i class="fa-solid fa-leaf"></i> MimiAdmin</span>
        <div class="flex gap-5 text-gray-500">
            <button onclick="switchTab('dashboard')" class="hover:text-[#ee4d2d]"><i class="fa-solid fa-chart-line text-xl"></i></button>
            <button onclick="switchTab('orders')" class="hover:text-[#ee4d2d] relative">
                <i class="fa-solid fa-clipboard-list text-xl"></i>
                <span id="badgeNewOrdersMob" class="hidden absolute -top-1 -right-2 w-4 h-4 bg-red-500 text-white text-[9px] flex items-center justify-center rounded-full border border-white">0</span>
            </button>
            <button onclick="switchTab('products')" class="hover:text-[#ee4d2d]"><i class="fa-solid fa-box text-xl"></i></button>
            <button onclick="logout()" class="text-red-500"><i class="fa-solid fa-right-from-bracket text-xl"></i></button>
        </div>
    </div>

    <!-- 3. MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full overflow-hidden pt-14 md:pt-0 relative bg-[#f8fafc]">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="p-4 md:p-8 overflow-y-auto h-full pb-20 custom-scrollbar">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">T·ªïng Quan H√¥m Nay</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-sack-dollar"></i> Doanh thu</div>
                    <div class="text-2xl font-bold text-[#ee4d2d] mt-auto" id="statRevenue">0‚Ç´</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-cart-shopping"></i> ƒê∆°n m·ªõi</div>
                    <div class="text-2xl font-bold text-blue-600 mt-auto" id="statNewOrders">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-truck-fast"></i> ƒêang giao</div>
                    <div class="text-2xl font-bold text-orange-500 mt-auto" id="statShipping">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-boxes-stacked"></i> S·∫£n ph·∫©m</div>
                    <div class="text-2xl font-bold text-green-600 mt-auto" id="statProducts">0</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-regular fa-clock"></i> ƒê∆°n h√†ng m·ªõi nh·∫•t</h3>
                    <button onclick="switchTab('orders')" class="text-xs font-bold text-[#ee4d2d] hover:underline">Xem t·∫•t c·∫£</button>
                </div>
                <div id="dashboardOrderList" class="divide-y divide-gray-100">
                    <div class="text-center py-8 text-gray-400 text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>

        <!-- ORDERS TAB (N√ÇNG C·∫§P M·∫†NH M·∫º) -->
        <div id="tab-orders" class="p-4 md:p-8 overflow-y-auto h-full pb-20 hidden custom-scrollbar">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                    <button onclick="loadOrders('all')" id="filter-all" class="px-4 py-1.5 rounded-md text-sm font-bold transition bg-gray-100 text-gray-800">T·∫•t c·∫£</button>
                    <button onclick="loadOrders('new')" id="filter-new" class="px-4 py-1.5 rounded-md text-sm font-bold transition text-gray-500 hover:bg-gray-50">ƒê∆°n m·ªõi</button>
                    <button onclick="loadOrders('shipping')" id="filter-shipping" class="px-4 py-1.5 rounded-md text-sm font-bold transition text-gray-500 hover:bg-gray-50">ƒêang giao</button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
                <!-- Desktop Table -->
                <table class="w-full text-sm text-left text-gray-500 desktop-table">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">M√£ ƒê∆°n</th>
                            <th class="px-6 py-3">Kh√°ch H√†ng</th>
                            <th class="px-6 py-3">Ng√†y ƒê·∫∑t</th>
                            <th class="px-6 py-3">T·ªïng Ti·ªÅn</th>
                            <th class="px-6 py-3">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-3 text-right">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
                <!-- Mobile List -->
                <div id="orderListMobile" class="md:hidden bg-gray-50 p-2 space-y-2"></div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="tab-products" class="p-4 md:p-8 overflow-y-auto h-full pb-20 hidden custom-scrollbar">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f3f4f6] z-10 py-2">
                <h2 class="text-2xl font-bold text-gray-800">S·∫£n Ph·∫©m</h2>
                <button onclick="openProductModal()" class="bg-[#ee4d2d] text-white px-4 py-2.5 rounded-lg shadow-lg shadow-orange-500/30 hover:bg-[#d73211] text-sm font-bold flex items-center gap-2 transition transform active:scale-95">
                    <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Th√™m S·∫£n Ph·∫©m</span>
                </button>
            </div>
            <div id="productList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Products Injected Here -->
            </div>
        </div>

    </div>

    <!-- MODAL CHI TI·∫æT ƒê∆†N H√ÄNG (FULL OPTIONS) -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-200" id="orderDetailContent">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice text-[#ee4d2d]"></i> Chi Ti·∫øt ƒê∆°n H√†ng
                </h3>
                <button onclick="closeModal('orderDetailModal')" class="text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <!-- Th√¥ng tin & C√¥ng c·ª• -->
                <div class="flex flex-col md:flex-row gap-6 mb-6">
                    <div class="flex-1 space-y-2 text-sm bg-gray-50 p-4 rounded border border-gray-100">
                        <div class="font-bold text-gray-800 border-b pb-1 mb-2 uppercase text-xs tracking-wider">Th√¥ng tin kh√°ch h√†ng</div>
                        <p><span class="text-gray-500 w-20 inline-block">H·ªç t√™n:</span> <span id="odName" class="font-medium text-lg"></span></p>
                        <p><span class="text-gray-500 w-20 inline-block">SƒêT:</span> <span id="odPhone" class="font-bold text-[#ee4d2d]"></span></p>
                        <p class="flex"><span class="text-gray-500 w-20 inline-block shrink-0">ƒê·ªãa ch·ªâ:</span> <span id="odAddress" class="font-medium"></span></p>
                        <p class="flex"><span class="text-gray-500 w-20 inline-block shrink-0">Ghi ch√∫:</span> <span id="odNote" class="italic text-gray-600 bg-yellow-100 px-2 rounded"></span></p>
                    </div>
                    
                    <div class="flex-1 space-y-3">
                         <!-- C√°c n√∫t ch·ª©c nƒÉng th√¥ng minh -->
                         <div class="grid grid-cols-2 gap-2">
                            <button onclick="printOrder()" class="bg-gray-700 text-white py-2 rounded text-xs font-bold hover:bg-gray-800 flex items-center justify-center gap-1"><i class="fa-solid fa-print"></i> In ƒê∆°n</button>
                            <button onclick="exportOrder()" class="bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center justify-center gap-1"><i class="fa-solid fa-file-export"></i> Xu·∫•t TXT</button>
                            <button onclick="shareOrder('zalo')" class="bg-blue-500 text-white py-2 rounded text-xs font-bold hover:bg-blue-600 flex items-center justify-center gap-1"><i class="fa-solid fa-share-nodes"></i> G·ª≠i Zalo</button>
                            <button onclick="deleteOrder()" class="bg-red-100 text-red-600 border border-red-200 py-2 rounded text-xs font-bold hover:bg-red-200 flex items-center justify-center gap-1"><i class="fa-solid fa-trash"></i> X√≥a ƒê∆°n</button>
                         </div>

                        <div class="bg-white p-3 rounded border-2 border-dashed border-[#ee4d2d]/30">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô</label>
                            <select id="odStatusSelect" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-[#ee4d2d] outline-none">
                                <option value="new">üÜï M·ªõi (Ch·ªù x√°c nh·∫≠n)</option>
                                <option value="shipping">üöö ƒêang giao h√†ng</option>
                                <option value="done">‚úÖ Ho√†n th√†nh</option>
                                <option value="cancel">‚ùå ƒê√£ h·ªßy</option>
                            </select>
                            <button onclick="updateOrderStatus()" class="w-full mt-2 bg-[#ee4d2d] text-white py-2 rounded text-sm font-bold hover:bg-[#d73211] transition shadow-md">
                                <i class="fa-solid fa-check"></i> L∆∞u Tr·∫°ng Th√°i
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Danh s√°ch s·∫£n ph·∫©m -->
                <div class="font-bold text-gray-800 border-b pb-1 mb-3 uppercase text-xs tracking-wider">Chi ti·∫øt ƒë∆°n h√†ng</div>
                <div id="odItems" class="space-y-3 mb-4">
                    <!-- Items injected here -->
                </div>
                
                <!-- T·ªïng ti·ªÅn -->
                <div class="flex justify-end items-center pt-4 border-t border-gray-100">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Ph√≠ v·∫≠n chuy·ªÉn: <span id="odShip" class="font-medium text-gray-800"></span></div>
                        <div class="text-lg font-bold text-gray-800 mt-1">T·ªïng thanh to√°n: <span id="odTotal" class="text-[#ee4d2d] text-2xl"></span></div>
                        <div class="text-xs text-gray-400 mt-1">Thanh to√°n: <span id="odPayment"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TH√äM/S·ª¨A S·∫¢N PH·∫®M -->
    <div id="productModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <!-- (Gi·ªØ nguy√™n form s·∫£n ph·∫©m nh∆∞ c≈©) -->
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-200" id="productModalContent">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800">Th√¥ng Tin S·∫£n Ph·∫©m</h3>
                <button onclick="closeModal('productModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <form id="productForm" onsubmit="saveProduct(event)" class="space-y-5">
                    <input type="hidden" id="productId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">T√™n s·∫£n ph·∫©m <span class="text-red-500">*</span></label><input type="text" id="pName" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" required></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">Gi√° c∆° b·∫£n (VNƒê) <span class="text-red-500">*</span></label><input type="number" id="pPrice" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" required></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Link ·∫¢nh Ch√≠nh (URL)</label>
                        <div class="flex gap-4 items-start"><div class="flex-1"><input type="text" id="pImg" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" oninput="document.getElementById('pImgPreview').src=this.value" required></div><img id="pImgPreview" src="https://via.placeholder.com/100" class="w-20 h-20 object-cover rounded border"></div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-3"><label class="text-sm font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-500"></i> Ph√¢n lo·∫°i h√†ng</label><button type="button" onclick="addVariantRow()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full font-bold hover:bg-blue-200 transition">+ Th√™m</button></div>
                        <div id="variantContainer" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2"></div>
                    </div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">M√¥ t·∫£</label><textarea id="pDesc" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none h-24 text-sm"></textarea></div>
                    <div class="pt-4 border-t flex justify-end gap-3 sticky bottom-0 bg-white"><button type="button" onclick="closeModal('productModal')" class="px-5 py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold">H·ªßy</button><button type="submit" class="px-6 py-2.5 bg-[#ee4d2d] text-white rounded-lg font-bold hover:bg-[#d73211] shadow-lg">L∆∞u S·∫£n Ph·∫©m</button></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDT0IEKhjAJZ_ZiMVwVCvO-fuj0ByReoE8",
            authDomain: "esomar-vnn.firebaseapp.com",
            projectId: "esomar-vnn",
            storageBucket: "esomar-vnn.firebasestorage.app",
            messagingSenderId: "1023271897973",
            appId: "1:1023271897973:web:c7207b0e8321fc271fe13c"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- AUTH ---
        function checkAuth() {
            // T·ª∞ ƒê·ªòNG LOGIN FIREBASE ·∫®N DANH ƒê·ªÇ ƒê·ªåC ƒê∆Ø·ª¢C DB
            auth.signInAnonymously().then(() => {
                const isAuth = localStorage.getItem('mimi_admin_auth');
                if(isAuth === 'true') {
                    document.getElementById('loginOverlay').classList.add('hidden');
                    switchTab('dashboard'); 
                } else {
                    document.getElementById('loginOverlay').classList.remove('hidden');
                }
            });
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === 'admin123') {
                localStorage.setItem('mimi_admin_auth', 'true');
                document.getElementById('loginOverlay').classList.add('hidden');
                switchTab('dashboard');
            } else {
                alert('Sai th√¥ng tin! (G·ª£i √Ω: admin / admin123)');
            }
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t?")) {
                localStorage.removeItem('mimi_admin_auth');
                window.location.reload();
            }
        }

        // --- NAVIGATION & TABS ---
        function switchTab(tabId) {
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active-nav'));
            if(document.getElementById(`nav-${tabId}`)) document.getElementById(`nav-${tabId}`).classList.add('active-nav');
            ['dashboard', 'orders', 'products'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            if(tabId === 'dashboard') loadDashboard();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'products') loadProducts();
        }

        // --- REALTIME DASHBOARD ---
        function loadDashboard() {
            db.collection("orders").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
                let revenue = 0, newOrders = 0, shipping = 0, html = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.status === 'done') revenue += (data.total || 0);
                    if(data.status === 'new') newOrders++;
                    if(data.status === 'shipping') shipping++;
                    
                    if(html.length < 2000) {
                        html += `
                        <div class="p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition" onclick="switchTab('orders'); setTimeout(() => viewOrder('${doc.id}'), 100)">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center font-bold text-xs">${data.customer?.name ? data.customer.name.charAt(0).toUpperCase() : '#'}</div>
                                <div><div class="font-bold text-sm text-gray-800 line-clamp-1">${data.customer?.name}</div><div class="text-xs text-gray-400">${getTimeAgo(data.createdAt?.toDate())}</div></div>
                            </div>
                            <div class="text-right"><div class="font-bold text-[#ee4d2d] text-sm">${formatMoney(data.total)}</div><div class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${getStatusColor(data.status)} inline-block">${getStatusText(data.status)}</div></div>
                        </div>`;
                    }
                });
                document.getElementById('statRevenue').innerText = formatMoney(revenue);
                document.getElementById('statNewOrders').innerText = newOrders;
                document.getElementById('statShipping').innerText = shipping;
                document.getElementById('dashboardOrderList').innerHTML = html || '<div class="p-4 text-center text-gray-400 text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>';
                
                const badge = document.getElementById('badgeNewOrders');
                if(newOrders > 0) { badge.innerText = newOrders; badge.classList.remove('hidden'); } else badge.classList.add('hidden');
            });
            db.collection("products").get().then(snap => document.getElementById('statProducts').innerText = snap.size);
        }

        // --- ORDER MANAGEMENT (REALTIME) ---
        let currentOrderData = null;
        let currentOrderId = null;
        let orderUnsub = null;

        function loadOrders(filter = 'all') {
            const tbody = document.getElementById('orderTableBody');
            const mobList = document.getElementById('orderListMobile');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8"><div class="loader mx-auto"></div></td></tr>';
            
            // Highlight filter button
            document.querySelectorAll('#tab-orders button').forEach(b => { b.classList.remove('bg-blue-100', 'text-blue-700'); b.classList.add('bg-gray-100'); });
            const btn = document.getElementById(`filter-${filter}`); if(btn) { btn.classList.remove('bg-gray-100'); btn.classList.add('bg-blue-100', 'text-blue-700'); }

            let query = db.collection("orders").orderBy("createdAt", "desc");
            if(filter !== 'all') query = query.where("status", "==", filter);

            if(orderUnsub) orderUnsub();

            orderUnsub = query.limit(50).onSnapshot(snap => {
                let htmlPC = '', htmlMob = '';
                if(snap.empty) { 
                    const empty = '<div class="text-center py-10 text-gray-400">Kh√¥ng c√≥ ƒë∆°n h√†ng</div>';
                    tbody.innerHTML = `<tr><td colspan="6">${empty}</td></tr>`; mobList.innerHTML = empty; return; 
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt ? formatDate(d.createdAt.toDate()) : '';
                    const badge = `<span class="px-2 py-1 rounded-md text-xs font-bold ${getStatusColor(d.status)} border border-white/50 shadow-sm">${getStatusText(d.status)}</span>`;
                    
                    htmlPC += `<tr class="bg-white border-b hover:bg-blue-50/50 transition cursor-pointer" onclick="viewOrder('${doc.id}')">
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">#${doc.id.slice(-6).toUpperCase()}</td>
                        <td class="px-6 py-4"><div class="font-bold text-gray-800 text-sm">${d.customer?.name}</div><div class="text-xs text-gray-500">${d.customer?.phone}</div></td>
                        <td class="px-6 py-4 text-xs text-gray-600">${date}</td>
                        <td class="px-6 py-4 font-bold text-[#ee4d2d]">${formatMoney(d.total)}</td>
                        <td class="px-6 py-4">${badge}</td>
                        <td class="px-6 py-4 text-right"><button class="text-gray-400 hover:text-blue-600 px-2"><i class="fa-solid fa-eye"></i></button></td>
                    </tr>`;

                    htmlMob += `<div class="mobile-card" onclick="viewOrder('${doc.id}')">
                        <div class="flex justify-between items-start mb-3 border-b border-dashed pb-2 border-gray-100">
                            <div class="flex items-center gap-2"><span class="font-mono text-xs font-bold text-gray-500 bg-gray-100 px-1 rounded">#${doc.id.slice(-6).toUpperCase()}</span><span class="text-xs text-gray-400">${getTimeAgo(d.createdAt?.toDate())}</span></div>
                            ${badge}
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3"><div class="w-10 h-10 rounded bg-blue-50 flex items-center justify-center text-blue-500 text-lg"><i class="fa-solid fa-user"></i></div><div><div class="text-sm font-bold text-gray-800">${d.customer?.name}</div><div class="text-xs text-gray-500">${d.customer?.phone}</div></div></div>
                            <div class="text-lg font-bold text-[#ee4d2d]">${formatMoney(d.total)}</div>
                        </div>
                    </div>`;
                });
                tbody.innerHTML = htmlPC; mobList.innerHTML = htmlMob;
            });
        }

        function viewOrder(id) {
            currentOrderId = id;
            db.collection("orders").doc(id).get().then(doc => {
                if(!doc.exists) return;
                const d = doc.data();
                currentOrderData = d;
                currentOrderData.id = id;

                document.getElementById('odName').innerText = d.customer?.name;
                document.getElementById('odPhone').innerText = d.customer?.phone;
                document.getElementById('odZalo').href = `https://zalo.me/${d.customer?.phone}`;
                document.getElementById('odAddress').innerText = d.customer?.fullAddress || d.customer?.address;
                document.getElementById('odNote').innerText = d.customer?.note || 'Kh√¥ng c√≥';
                document.getElementById('odPayment').innerText = d.paymentMethod === 'banking' ? 'Chuy·ªÉn kho·∫£n' : 'COD';
                document.getElementById('odStatusSelect').value = d.status;
                document.getElementById('odTotal').innerText = formatMoney(d.total);
                document.getElementById('odShip').innerText = formatMoney(d.shippingFee || 0);
                document.getElementById('odItemCount').innerText = d.items ? d.items.length : 0;

                const itemsContainer = document.getElementById('odItems');
                itemsContainer.innerHTML = '';
                if(d.items) {
                    d.items.forEach(item => {
                        itemsContainer.innerHTML += `
                        <div class="flex gap-3 bg-gray-50 p-2 rounded border border-gray-100">
                            <div class="w-12 h-12 shrink-0 bg-white rounded border overflow-hidden"><img src="${item.image || 'https://via.placeholder.com/50'}" class="w-full h-full object-cover"></div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-800 line-clamp-1">${item.name}</div>
                                <div class="text-xs text-gray-500 mt-0.5">Ph√¢n lo·∫°i: <span class="font-bold">${item.variant}</span></div>
                                <div class="flex justify-between items-center mt-1"><span class="text-xs bg-white border px-1.5 rounded text-gray-600">x${item.qty}</span><span class="text-sm font-bold text-[#ee4d2d]">${formatMoney(item.price)}</span></div>
                            </div>
                        </div>`;
                    });
                }
                
                const modal = document.getElementById('orderDetailModal');
                const content = document.getElementById('orderDetailContent');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); });
            });
        }

        // --- C√ÅC T√çNH NƒÇNG TH√îNG MINH M·ªöI (IN, XU·∫§T, G·ª¨I, X√ìA) ---

        // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateOrderStatus() {
            const newStatus = document.getElementById('odStatusSelect').value;
            db.collection("orders").doc(currentOrderId).update({ status: newStatus }).then(() => {
                alert("ƒê√£ c·∫≠p nh·∫≠t!"); closeModal('orderDetailModal');
            });
        }

        // 2. X√≥a ƒë∆°n h√†ng
        function deleteOrder() {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN ƒë∆°n h√†ng n√†y?")) {
                db.collection("orders").doc(currentOrderId).delete().then(() => {
                    alert("ƒê√£ x√≥a ƒë∆°n h√†ng!"); closeModal('orderDetailModal');
                });
            }
        }

        // 3. In ƒë∆°n h√†ng (M·ªü c·ª≠a s·ªï in)
        function printOrder() {
            const d = currentOrderData;
            const printWindow = window.open('', '_blank');
            let itemsHtml = '';
            d.items.forEach(i => {
                itemsHtml += `<tr><td>${i.name} (${i.variant})</td><td>${i.qty}</td><td style="text-align:right">${formatMoney(i.price * i.qty)}</td></tr>`;
            });

            printWindow.document.write(`
                <html><head><title>H√≥a ƒë∆°n ${d.id}</title>
                <style>body{font-family:Arial,sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #ddd}th{text-align:left}.total{text-align:right;font-size:18px;font-weight:bold;margin-top:20px}</style>
                </head><body>
                <h2 style="text-align:center">MIMI FLOWER SHOP</h2>
                <p>Kh√°ch h√†ng: ${d.customer.name}</p>
                <p>SƒêT: ${d.customer.phone}</p>
                <p>ƒê·ªãa ch·ªâ: ${d.customer.fullAddress}</p>
                <p>Ghi ch√∫: ${d.customer.note}</p>
                <hr>
                <table><thead><tr><th>S·∫£n ph·∫©m</th><th>SL</th><th style="text-align:right">T.Ti·ªÅn</th></tr></thead><tbody>${itemsHtml}</tbody></table>
                <div class="total">T·ªïng c·ªông: ${formatMoney(d.total)}</div>
                <div style="text-align:center;margin-top:40px;font-size:12px">C·∫£m ∆°n qu√Ω kh√°ch!</div>
                </body></html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // 4. Xu·∫•t file TXT
        function exportOrder() {
            const d = currentOrderData;
            let text = `ƒê∆†N H√ÄNG #${d.id.slice(-6).toUpperCase()}\n`;
            text += `--------------------------------\n`;
            text += `Kh√°ch h√†ng: ${d.customer.name}\nSƒêT: ${d.customer.phone}\nƒê·ªãa ch·ªâ: ${d.customer.fullAddress}\n`;
            text += `--------------------------------\n`;
            d.items.forEach(i => { text += `- ${i.name} (${i.variant}) x${i.qty} = ${formatMoney(i.price * i.qty)}\n`; });
            text += `--------------------------------\n`;
            text += `T·ªîNG C·ªòNG: ${formatMoney(d.total)}\n`;
            
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `DonHang_${d.customer.name}_${d.id}.txt`;
            a.click();
        }

        // 5. G·ª≠i Zalo/Telegram (Share)
        function shareOrder(platform) {
            const d = currentOrderData;
            let text = `ƒê∆°n h√†ng m·ªõi:\nKH: ${d.customer.name} - ${d.customer.phone}\nƒêC: ${d.customer.fullAddress}\nH√†ng:\n`;
            d.items.forEach(i => { text += `- ${i.name} x${i.qty}\n`; });
            text += `T·ªïng: ${formatMoney(d.total)}`;
            
            if(platform === 'zalo') {
                // Copy to clipboard tr∆∞·ªõc v√¨ Zalo Web kh√¥ng h·ªó tr·ª£ deeplink text t·ªët
                navigator.clipboard.writeText(text).then(() => {
                    alert("ƒê√£ copy n·ªôi dung ƒë∆°n! ƒêang m·ªü Zalo...");
                    window.open('https://chat.zalo.me/', '_blank');
                });
            }
        }

        // --- PRODUCT MANAGEMENT (GI·ªÆ NGUY√äN) ---
        // (Ph·∫ßn n√†y b·∫°n ƒë√£ c√≥ trong code c≈©, t√¥i t√≠ch h·ª£p l·∫°i y h·ªát nh∆∞ng style ƒë·∫πp h∆°n)
        function loadProducts() {
            const grid = document.getElementById('productList');
            grid.innerHTML = '<div class="loader mx-auto col-span-full"></div>';
            db.collection("products").orderBy("createdAt", "desc").get().then(snap => {
                let html = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    html += `<div class="bg-white rounded border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition relative group">
                        <div class="aspect-square bg-gray-100 relative"><img src="${p.images?.[0]}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center gap-2">
                            <button onclick="editProduct('${doc.id}')" class="bg-blue-500 text-white p-2 rounded-full"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteProduct('${doc.id}')" class="bg-red-500 text-white p-2 rounded-full"><i class="fa-solid fa-trash"></i></button>
                        </div></div>
                        <div class="p-3"><h3 class="font-bold text-gray-800 line-clamp-1 text-sm">${p.name}</h3>
                        <div class="flex justify-between items-center mt-2"><span class="text-[#ee4d2d] font-bold">${formatMoney(p.basePrice)}</span><span class="text-xs text-gray-500">${p.variants?.length||0} lo·∫°i</span></div></div>
                    </div>`;
                });
                grid.innerHTML = html;
            });
        }

        function openProductModal() { document.getElementById('productForm').reset(); document.getElementById('productId').value=''; document.getElementById('variantContainer').innerHTML=''; document.getElementById('productModal').classList.remove('hidden'); }
        function saveProduct(e) { e.preventDefault(); /* ... Logic l∆∞u s·∫£n ph·∫©m c≈© ... */ } 
        // (ƒê·ªÉ g·ªçn code, t√¥i d√πng l·∫°i logic save/delete/edit product y h·ªát file c≈© c·ªßa b·∫°n, ch·ªâ thay class Tailwind)

        // --- UTILS ---
        function closeModal(id) { 
            const modal = document.getElementById(id); const content = modal.firstElementChild;
            modal.classList.add('opacity-0'); if(content) content.classList.remove('scale-100');
            setTimeout(() => modal.classList.add('hidden'), 200); 
        }
        function formatMoney(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }
        function formatDate(d) { return d ? d.toLocaleString('vi-VN') : ''; }
        function getTimeAgo(date) { if(!date) return ''; const s = Math.floor((new Date()-date)/1000); if(s<60) return 'V·ª´a xong'; const m=Math.floor(s/60); if(m<60) return `${m} ph√∫t tr∆∞·ªõc`; const h=Math.floor(m/60); if(h<24) return `${h} gi·ªù tr∆∞·ªõc`; return formatDate(date); }
        function getStatusText(s) { const map = { 'new': 'M·ªõi', 'shipping': 'ƒêang giao', 'done': 'Ho√†n th√†nh', 'cancel': 'ƒê√£ h·ªßy' }; return map[s] || s; }
        function getStatusColor(s) { const map = { 'new': 'bg-blue-100 text-blue-800', 'shipping': 'bg-orange-100 text-orange-800', 'done': 'bg-green-100 text-green-800', 'cancel': 'bg-red-100 text-red-800' }; return map[s] || 'bg-gray-100'; }

        // Logic Add/Edit Product (Thu g·ªçn)
        function editProduct(id) { db.collection("products").doc(id).get().then(doc => { if(doc.exists) { const p = doc.data(); document.getElementById('productId').value=id; document.getElementById('pName').value=p.name; document.getElementById('pPrice').value=p.basePrice; document.getElementById('pImg').value=p.images[0]; document.getElementById('pDesc').value=p.description; const c = document.getElementById('variantContainer'); c.innerHTML=''; if(p.variants) p.variants.forEach(v=>addVariantRow(v.name,v.price,v.image)); document.getElementById('productModal').classList.remove('hidden'); }}); }
        function addVariantRow(n='',p='',i='') { const d=document.createElement('div'); d.className='flex gap-2 mb-2'; d.innerHTML=`<input class="v-name border p-1 w-1/3 rounded" placeholder="T√™n" value="${n}"><input class="v-price border p-1 w-1/4 rounded" type="number" placeholder="Gi√°" value="${p}"><input class="v-img border p-1 w-1/3 rounded" placeholder="·∫¢nh" value="${i}"><button type="button" onclick="this.parentElement.remove()" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`; document.getElementById('variantContainer').appendChild(d); }
        window.saveProduct = function(e) { e.preventDefault(); const id = document.getElementById('productId').value; const vs = []; document.querySelectorAll('#variantContainer > div').forEach(r => { vs.push({name: r.querySelector('.v-name').value, price: parseInt(r.querySelector('.v-price').value), image: r.querySelector('.v-img').value}); }); const d = { name: document.getElementById('pName').value, basePrice: parseInt(document.getElementById('pPrice').value), description: document.getElementById('pDesc').value, images: [document.getElementById('pImg').value], variants: vs, createdAt: firebase.firestore.FieldValue.serverTimestamp() }; if(id) { delete d.createdAt; db.collection("products").doc(id).update(d).then(() => { alert("ƒê√£ l∆∞u!"); closeModal('productModal'); loadProducts(); }); } else { db.collection("products").add(d).then(() => { alert("ƒê√£ th√™m!"); closeModal('productModal'); loadProducts(); }); } };
        function deleteProduct(id) { if(confirm("X√≥a s·∫£n ph·∫©m?")) db.collection("products").doc(id).delete().then(loadProducts); }

        window.onload = checkAuth;
    </script>
</body>
</html>
