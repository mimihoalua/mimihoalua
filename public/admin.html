<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K√™nh Ng∆∞·ªùi B√°n - MimiFlower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK (Ph·∫£i kh·ªõp version v·ªõi index.html) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .active-nav { background-color: #fff1f2; color: #ee4d2d; border-right: 3px solid #ee4d2d; font-weight: bold; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #ee4d2d; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Responsive Table to Cards */
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-card { display: block; border-bottom: 1px solid #e5e7eb; padding: 12px; background: white; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .desktop-table { display: none; }
        }
        @media (min-width: 769px) {
            .mobile-card { display: none; }
            .desktop-table { display: table; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- 1. LOGIN OVERLAY (SIMPLE AUTH) -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-[#ee4d2d]">
                    <i class="fa-solid fa-store text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">K√™nh Ng∆∞·ªùi B√°n</h2>
                <p class="text-gray-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω MimiFlower</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">T√†i kho·∫£n</label>
                    <input type="text" id="username" class="w-full border p-2.5 rounded focus:border-[#ee4d2d] focus:ring-1 focus:ring-[#ee4d2d] outline-none mt-1" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full border p-2.5 rounded focus:border-[#ee4d2d] focus:ring-1 focus:ring-[#ee4d2d] outline-none mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-[#ee4d2d] text-white py-2.5 rounded font-bold hover:bg-[#d73211] transition shadow-lg shadow-orange-500/30">ƒêƒÉng Nh·∫≠p</button>
            </form>
        </div>
    </div>

    <!-- 2. SIDEBAR (PC) -->
    <div class="w-64 bg-white border-r border-gray-200 flex-col hidden md:flex z-20">
        <div class="p-4 border-b border-gray-100 flex items-center gap-2">
            <i class="fa-solid fa-leaf text-[#ee4d2d] text-xl"></i>
            <span class="font-bold text-xl tracking-tight text-gray-800">MimiManager</span>
        </div>
        <nav class="flex-1 py-4 space-y-1">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition active-nav">
                <i class="fa-solid fa-chart-line w-5 text-center"></i> T·ªïng Quan
            </a>
            <a href="#" onclick="switchTab('orders')" id="nav-orders" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition">
                <i class="fa-solid fa-clipboard-list w-5 text-center"></i> ƒê∆°n H√†ng 
                <span id="badgeNewOrders" class="hidden ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
            </a>
            <a href="#" onclick="switchTab('products')" id="nav-products" class="flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition">
                <i class="fa-solid fa-box w-5 text-center"></i> S·∫£n Ph·∫©m
            </a>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500"><i class="fa-solid fa-user"></i></div>
                <div class="text-sm">
                    <div class="font-bold text-gray-800">Admin</div>
                    <div class="text-xs text-gray-500">Ch·ªß Shop</div>
                </div>
            </div>
            <button onclick="logout()" class="flex items-center gap-2 text-red-500 hover:text-red-700 text-sm w-full px-2">
                <i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t
            </button>
        </div>
    </div>

    <!-- MOBILE HEADER (Thay th·∫ø sidebar tr√™n mobile) -->
    <div class="md:hidden fixed top-0 left-0 right-0 h-14 bg-white border-b border-gray-200 z-30 flex items-center justify-between px-4 shadow-sm">
        <span class="font-bold text-lg text-[#ee4d2d] flex items-center gap-2"><i class="fa-solid fa-leaf"></i> MimiAdmin</span>
        <div class="flex gap-5 text-gray-500">
            <button onclick="switchTab('dashboard')" class="hover:text-[#ee4d2d]"><i class="fa-solid fa-chart-line text-xl"></i></button>
            <button onclick="switchTab('orders')" class="hover:text-[#ee4d2d] relative">
                <i class="fa-solid fa-clipboard-list text-xl"></i>
                <span id="badgeNewOrdersMob" class="hidden absolute -top-1 -right-2 w-4 h-4 bg-red-500 text-white text-[9px] flex items-center justify-center rounded-full border border-white">0</span>
            </button>
            <button onclick="switchTab('products')" class="hover:text-[#ee4d2d]"><i class="fa-solid fa-box text-xl"></i></button>
            <button onclick="logout()" class="text-red-500"><i class="fa-solid fa-right-from-bracket text-xl"></i></button>
        </div>
    </div>

    <!-- 3. MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full overflow-hidden pt-14 md:pt-0 relative bg-[#f8fafc]">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="p-4 md:p-8 overflow-y-auto h-full pb-20 custom-scrollbar">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">T·ªïng Quan H√¥m Nay</h2>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-sack-dollar"></i> Doanh thu</div>
                    <div class="text-2xl font-bold text-[#ee4d2d] mt-auto" id="statRevenue">0‚Ç´</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-cart-shopping"></i> ƒê∆°n m·ªõi</div>
                    <div class="text-2xl font-bold text-blue-600 mt-auto" id="statNewOrders">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-truck-fast"></i> ƒêang giao</div>
                    <div class="text-2xl font-bold text-orange-500 mt-auto" id="statShipping">0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                    <div class="text-gray-400 text-xs uppercase font-bold mb-1 flex items-center gap-1"><i class="fa-solid fa-boxes-stacked"></i> S·∫£n ph·∫©m</div>
                    <div class="text-2xl font-bold text-green-600 mt-auto" id="statProducts">0</div>
                </div>
            </div>

            <!-- Recent Orders Preview -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-regular fa-clock"></i> ƒê∆°n h√†ng m·ªõi nh·∫•t</h3>
                    <button onclick="switchTab('orders')" class="text-xs font-bold text-[#ee4d2d] hover:underline">Xem t·∫•t c·∫£</button>
                </div>
                <div id="dashboardOrderList" class="divide-y divide-gray-100">
                    <!-- JS Injected -->
                    <div class="text-center py-8 text-gray-400 text-sm">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tab-orders" class="p-4 md:p-8 overflow-y-auto h-full pb-20 hidden custom-scrollbar">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                    <button onclick="loadOrders('all')" id="filter-all" class="px-4 py-1.5 rounded-md text-sm font-bold transition bg-gray-100 text-gray-800">T·∫•t c·∫£</button>
                    <button onclick="loadOrders('new')" id="filter-new" class="px-4 py-1.5 rounded-md text-sm font-bold transition text-gray-500 hover:bg-gray-50">ƒê∆°n m·ªõi</button>
                    <button onclick="loadOrders('shipping')" id="filter-shipping" class="px-4 py-1.5 rounded-md text-sm font-bold transition text-gray-500 hover:bg-gray-50">ƒêang giao</button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[400px]">
                <!-- Desktop Table -->
                <table class="w-full text-sm text-left text-gray-500 desktop-table">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3">M√£ ƒê∆°n</th>
                            <th class="px-6 py-3">Kh√°ch H√†ng</th>
                            <th class="px-6 py-3">Ng√†y ƒê·∫∑t</th>
                            <th class="px-6 py-3">T·ªïng Ti·ªÅn</th>
                            <th class="px-6 py-3">Tr·∫°ng Th√°i</th>
                            <th class="px-6 py-3 text-right">H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
                <!-- Mobile List -->
                <div id="orderListMobile" class="md:hidden bg-gray-50 p-2 space-y-2"></div>
            </div>
        </div>

        <!-- PRODUCTS TAB -->
        <div id="tab-products" class="p-4 md:p-8 overflow-y-auto h-full pb-20 hidden custom-scrollbar">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-[#f3f4f6] z-10 py-2">
                <h2 class="text-2xl font-bold text-gray-800">S·∫£n Ph·∫©m</h2>
                <button onclick="openProductModal()" class="bg-[#ee4d2d] text-white px-4 py-2.5 rounded-lg shadow-lg shadow-orange-500/30 hover:bg-[#d73211] text-sm font-bold flex items-center gap-2 transition transform active:scale-95">
                    <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">Th√™m S·∫£n Ph·∫©m</span>
                </button>
            </div>
            <div id="productList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Products Injected Here -->
            </div>
        </div>

    </div>

    <!-- MODAL CHI TI·∫æT ƒê∆†N H√ÄNG (ORDER DETAIL) -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-200" id="orderDetailContent">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice text-[#ee4d2d]"></i> Chi Ti·∫øt ƒê∆°n H√†ng
                </h3>
                <button onclick="closeModal('orderDetailModal')" class="text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <!-- Th√¥ng tin kh√°ch & Tr·∫°ng th√°i -->
                <div class="flex flex-col md:flex-row gap-6 mb-6">
                    <div class="flex-1 space-y-2 text-sm">
                        <div class="font-bold text-gray-800 border-b pb-1 mb-2 uppercase text-xs tracking-wider">Kh√°ch h√†ng</div>
                        <p><span class="text-gray-500 w-20 inline-block">H·ªç t√™n:</span> <span id="odName" class="font-medium"></span></p>
                        <p><span class="text-gray-500 w-20 inline-block">SƒêT:</span> <span id="odPhone" class="font-medium"></span> <a href="#" id="odZalo" target="_blank" class="text-blue-500 hover:underline text-xs ml-1"><i class="fa-solid fa-message"></i> Zalo</a></p>
                        <p class="flex"><span class="text-gray-500 w-20 inline-block shrink-0">ƒê·ªãa ch·ªâ:</span> <span id="odAddress" class="font-medium"></span></p>
                        <p class="flex"><span class="text-gray-500 w-20 inline-block shrink-0">Ghi ch√∫:</span> <span id="odNote" class="italic text-gray-600 bg-yellow-50 px-2 rounded"></span></p>
                    </div>
                    <div class="flex-1 space-y-3">
                        <div class="font-bold text-gray-800 border-b pb-1 mb-2 uppercase text-xs tracking-wider">Tr·∫°ng th√°i ƒë∆°n</div>
                        <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô</label>
                            <select id="odStatusSelect" class="w-full border border-gray-300 p-2 rounded text-sm focus:border-[#ee4d2d] outline-none">
                                <option value="new">üÜï M·ªõi (Ch·ªù x√°c nh·∫≠n)</option>
                                <option value="shipping">üöö ƒêang giao h√†ng</option>
                                <option value="done">‚úÖ Ho√†n th√†nh</option>
                                <option value="cancel">‚ùå ƒê√£ h·ªßy</option>
                            </select>
                            <button onclick="updateOrderStatus()" class="w-full mt-2 bg-gray-800 text-white py-2 rounded text-sm font-bold hover:bg-gray-900 transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> L∆∞u Tr·∫°ng Th√°i
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between">
                            <span>Thanh to√°n: <span id="odPayment" class="font-bold text-gray-800"></span></span>
                            <span>Ng√†y ƒë·∫∑t: <span id="odDate"></span></span>
                        </div>
                    </div>
                </div>
                
                <!-- Danh s√°ch s·∫£n ph·∫©m -->
                <div class="font-bold text-gray-800 border-b pb-1 mb-3 uppercase text-xs tracking-wider">S·∫£n ph·∫©m ƒë·∫∑t mua (<span id="odItemCount">0</span>)</div>
                <div id="odItems" class="space-y-3 mb-4">
                    <!-- Items injected here -->
                </div>
                
                <!-- T·ªïng ti·ªÅn -->
                <div class="flex justify-end items-center pt-4 border-t border-gray-100">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Ph√≠ v·∫≠n chuy·ªÉn: <span id="odShip" class="font-medium text-gray-800"></span></div>
                        <div class="text-lg font-bold text-gray-800 mt-1">T·ªïng thanh to√°n: <span id="odTotal" class="text-[#ee4d2d] text-2xl"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL TH√äM/S·ª¨A S·∫¢N PH·∫®M -->
    <div id="productModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-200" id="productModalContent">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-800">Th√¥ng Tin S·∫£n Ph·∫©m</h3>
                <button onclick="closeModal('productModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <form id="productForm" onsubmit="saveProduct(event)" class="space-y-5">
                    <input type="hidden" id="productId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">T√™n s·∫£n ph·∫©m <span class="text-red-500">*</span></label>
                            <input type="text" id="pName" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" required placeholder="V√≠ d·ª•: B√¨nh hoa m·∫´u ƒë∆°n...">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Gi√° c∆° b·∫£n (VNƒê) <span class="text-red-500">*</span></label>
                            <input type="number" id="pPrice" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" required placeholder="500000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Link ·∫¢nh Ch√≠nh (URL) <span class="text-red-500">*</span></label>
                        <div class="flex gap-4 items-start">
                            <div class="flex-1">
                                <input type="text" id="pImg" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none" placeholder="https://..." oninput="document.getElementById('pImgPreview').src=this.value" required>
                                <p class="text-xs text-gray-400 mt-1">D√°n link ·∫£nh t·ª´ Facebook, Google Photos ho·∫∑c Imgur.</p>
                            </div>
                            <img id="pImgPreview" src="https://via.placeholder.com/100?text=IMG" class="w-20 h-20 object-cover rounded border border-gray-200 bg-gray-50">
                        </div>
                    </div>

                    <!-- Khu v·ª±c bi·∫øn th·ªÉ -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-sm font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-500"></i> Ph√¢n lo·∫°i h√†ng (M√†u/Size)</label>
                            <button type="button" onclick="addVariantRow()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full font-bold hover:bg-blue-200 transition"><i class="fa-solid fa-plus"></i> Th√™m ph√¢n lo·∫°i</button>
                        </div>
                        <div id="variantContainer" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">
                            <!-- Variant Rows Injected Here -->
                        </div>
                        <p class="text-xs text-gray-400 mt-2 italic">N·∫øu kh√¥ng c√≥ ph√¢n lo·∫°i, h·ªá th·ªëng s·∫Ω d√πng gi√° v√† ·∫£nh ch√≠nh.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                        <textarea id="pDesc" class="w-full border p-2 rounded focus:border-[#ee4d2d] outline-none h-24 text-sm" placeholder="Ch·∫•t li·ªáu, k√≠ch th∆∞·ªõc, h∆∞·ªõng d·∫´n b·∫£o qu·∫£n..."></textarea>
                    </div>

                    <div class="pt-4 border-t flex justify-end gap-3 sticky bottom-0 bg-white">
                        <button type="button" onclick="closeModal('productModal')" class="px-5 py-2.5 bg-gray-100 rounded-lg text-gray-600 font-bold hover:bg-gray-200 transition">H·ªßy</button>
                        <button type="submit" class="px-6 py-2.5 bg-[#ee4d2d] text-white rounded-lg font-bold hover:bg-[#d73211] transition shadow-lg shadow-orange-500/30 flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> L∆∞u S·∫£n Ph·∫©m
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG FIREBASE (PH·∫¢I GI·ªêNG FILE INDEX.HTML) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDT0IEKhjAJZ_ZiMVwVCvO-fuj0ByReoE8",
            authDomain: "esomar-vnn.firebaseapp.com",
            projectId: "esomar-vnn",
            storageBucket: "esomar-vnn.firebasestorage.app",
            messagingSenderId: "1023271897973",
            appId: "1:1023271897973:web:c7207b0e8321fc271fe13c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- AUTH LOGIC (SIMPLE) ---
        function checkAuth() {
            const isAuth = localStorage.getItem('mimi_admin_auth');
            if(isAuth === 'true') {
                document.getElementById('loginOverlay').classList.add('hidden');
                switchTab('dashboard'); // Load default
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            // Hardcoded Credentials (theo y√™u c·∫ßu)
            if(u === 'admin' && p === 'admin123') {
                localStorage.setItem('mimi_admin_auth', 'true');
                document.getElementById('loginOverlay').classList.add('hidden');
                switchTab('dashboard');
            } else {
                alert('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u! (G·ª£i √Ω: admin / admin123)');
            }
        }

        function logout() {
            if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
                localStorage.removeItem('mimi_admin_auth');
                window.location.reload();
            }
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            // UI
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active-nav'));
            const activeLink = document.getElementById(`nav-${tabId}`);
            if(activeLink) activeLink.classList.add('active-nav');
            
            // Mobile UI Sync (T√¥ m√†u icon mobile)
            document.querySelectorAll('.md\\:hidden button').forEach(b => b.classList.remove('text-[#ee4d2d]'));
            
            // Content
            ['dashboard', 'orders', 'products'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            const tabContent = document.getElementById(`tab-${tabId}`);
            tabContent.classList.remove('hidden');
            
            // Load Data
            if(tabId === 'dashboard') loadDashboard();
            if(tabId === 'orders') loadOrders();
            if(tabId === 'products') loadProducts();
        }

        // --- DASHBOARD LOGIC (REAL-TIME) ---
        function loadDashboard() {
            // L·∫Øng nghe realtime ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë li·ªáu ngay l·∫≠p t·ª©c
            db.collection("orders").orderBy("createdAt", "desc").limit(50).onSnapshot(snap => {
                let revenue = 0;
                let newOrders = 0;
                let shipping = 0;
                let html = '';

                snap.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate() : new Date();
                    
                    if(data.status === 'done') revenue += (data.total || 0);
                    if(data.status === 'new') newOrders++;
                    if(data.status === 'shipping') shipping++;

                    // List ƒë∆°n m·ªõi nh·∫•t (Dashboard list)
                    if(html.length < 2000) { // Gi·ªõi h·∫°n hi·ªÉn th·ªã
                        html += `
                        <div class="p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition" onclick="switchTab('orders'); setTimeout(() => viewOrder('${doc.id}'), 100)">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center font-bold text-xs">
                                    ${data.customer?.name ? data.customer.name.charAt(0).toUpperCase() : '#'}
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-gray-800 line-clamp-1">${data.customer?.name || 'Kh√°ch l·∫ª'}</div>
                                    <div class="text-xs text-gray-400">${getTimeAgo(date)}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-[#ee4d2d] text-sm">${formatMoney(data.total)}</div>
                                <div class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${getStatusColor(data.status)} inline-block">${getStatusText(data.status)}</div>
                            </div>
                        </div>`;
                    }
                });

                document.getElementById('statRevenue').innerText = formatMoney(revenue);
                document.getElementById('statNewOrders').innerText = newOrders;
                document.getElementById('statShipping').innerText = shipping;
                document.getElementById('dashboardOrderList').innerHTML = html || '<div class="p-4 text-center text-gray-400 text-sm">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</div>';
                
                // Badges
                const badge = document.getElementById('badgeNewOrders');
                const badgeMob = document.getElementById('badgeNewOrdersMob');
                if(newOrders > 0) {
                    badge.innerText = newOrders; badge.classList.remove('hidden');
                    badgeMob.innerText = newOrders; badgeMob.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden'); badgeMob.classList.add('hidden');
                }
            });

            db.collection("products").get().then(snap => {
                document.getElementById('statProducts').innerText = snap.size;
            });
        }

        // --- ORDERS LOGIC ---
        let currentOrderId = null;
        let ordersUnsubscribe = null; // ƒê·ªÉ h·ªßy listener khi chuy·ªÉn tab

        function loadOrders(filter = 'all') {
            const tbody = document.getElementById('orderTableBody');
            const mobList = document.getElementById('orderListMobile');
            
            // Loading state
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8"><div class="loader mx-auto"></div></td></tr>';
            mobList.innerHTML = '<div class="text-center py-8"><div class="loader mx-auto"></div></div>';
            
            // Update Filter UI
            document.querySelectorAll('#tab-orders button[id^="filter-"]').forEach(b => {
                b.classList.remove('bg-blue-100', 'text-blue-700');
                b.classList.add('bg-gray-100', 'text-gray-600');
            });
            const activeFilterBtn = document.getElementById(`filter-${filter}`);
            if(activeFilterBtn) {
                activeFilterBtn.classList.remove('bg-gray-100', 'text-gray-600');
                activeFilterBtn.classList.add('bg-blue-100', 'text-blue-700');
            }

            // Query
            let query = db.collection("orders").orderBy("createdAt", "desc");
            if(filter !== 'all') query = query.where("status", "==", filter);

            if(ordersUnsubscribe) ordersUnsubscribe(); // Stop old listener

            ordersUnsubscribe = query.limit(50).onSnapshot(snap => {
                let htmlDesktop = '';
                let htmlMobile = '';

                if(snap.empty) {
                    const emptyHtml = `
                        <div class="text-center py-10 flex flex-col items-center justify-center text-gray-400">
                            <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                            <span>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</span>
                        </div>`;
                    tbody.innerHTML = `<tr><td colspan="6">${emptyHtml}</td></tr>`;
                    mobList.innerHTML = emptyHtml;
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt ? d.createdAt.toDate() : new Date();
                    const statusBadge = `<span class="px-2 py-1 rounded-md text-xs font-bold ${getStatusColor(d.status)} border border-white/50 shadow-sm">${getStatusText(d.status)}</span>`;
                    
                    // Desktop Row
                    htmlDesktop += `
                    <tr class="bg-white border-b hover:bg-blue-50/50 transition cursor-pointer" onclick="viewOrder('${doc.id}')">
                        <td class="px-6 py-4 font-mono text-xs text-gray-500">#${doc.id.slice(-6).toUpperCase()}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600">
                                    ${d.customer?.name ? d.customer.name.charAt(0).toUpperCase() : '?'}
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-800">${d.customer?.name}</div>
                                    <div class="text-xs text-gray-500">${d.customer?.phone}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-600">${formatDate(date)}</td>
                        <td class="px-6 py-4 font-bold text-[#ee4d2d]">${formatMoney(d.total)}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-gray-400 hover:text-blue-600 px-2"><i class="fa-solid fa-eye"></i></button>
                        </td>
                    </tr>`;

                    // Mobile Card
                    htmlMobile += `
                    <div class="mobile-card" onclick="viewOrder('${doc.id}')">
                        <div class="flex justify-between items-start mb-3 border-b border-dashed pb-2 border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-xs font-bold text-gray-500 bg-gray-100 px-1 rounded">#${doc.id.slice(-6).toUpperCase()}</span>
                                <span class="text-xs text-gray-400">${getTimeAgo(date)}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-blue-50 flex items-center justify-center text-blue-500 text-lg">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-800">${d.customer?.name}</div>
                                    <div class="text-xs text-gray-500">${d.customer?.phone}</div>
                                </div>
                            </div>
                            <div class="text-lg font-bold text-[#ee4d2d]">${formatMoney(d.total)}</div>
                        </div>
                    </div>`;
                });

                tbody.innerHTML = htmlDesktop;
                mobList.innerHTML = htmlMobile;
            });
        }

        function viewOrder(id) {
            currentOrderId = id;
            // Hi·ªáu ·ª©ng m·ªü modal
            const modal = document.getElementById('orderDetailModal');
            const content = document.getElementById('orderDetailContent');
            
            db.collection("orders").doc(id).get().then(doc => {
                if(!doc.exists) return;
                const d = doc.data();
                
                document.getElementById('odName').innerText = d.customer?.name;
                document.getElementById('odPhone').innerText = d.customer?.phone;
                document.getElementById('odZalo').href = `https://zalo.me/${d.customer?.phone}`;
                document.getElementById('odAddress').innerText = d.customer?.fullAddress || d.customer?.address || 'T·∫°i c·ª≠a h√†ng';
                document.getElementById('odNote').innerText = d.customer?.note || 'Kh√¥ng c√≥ ghi ch√∫';
                if(!d.customer?.note) document.getElementById('odNote').classList.add('hidden');
                else document.getElementById('odNote').classList.remove('hidden');

                document.getElementById('odDate').innerText = formatDate(d.createdAt ? d.createdAt.toDate() : new Date());
                document.getElementById('odPayment').innerText = d.paymentMethod === 'banking' ? 'Chuy·ªÉn kho·∫£n (Techcombank)' : 'Ti·ªÅn m·∫∑t (COD)';
                document.getElementById('odStatusSelect').value = d.status;
                document.getElementById('odTotal').innerText = formatMoney(d.total);
                document.getElementById('odShip').innerText = formatMoney(d.shippingFee || 0);
                document.getElementById('odItemCount').innerText = d.items ? d.items.length : 0;

                const itemsContainer = document.getElementById('odItems');
                itemsContainer.innerHTML = '';
                if(d.items) {
                    d.items.forEach(item => {
                        itemsContainer.innerHTML += `
                        <div class="flex gap-3 bg-gray-50 p-2 rounded border border-gray-100">
                            <div class="w-12 h-12 shrink-0 bg-white rounded border overflow-hidden">
                                <img src="${item.image || 'https://via.placeholder.com/50'}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-gray-800 line-clamp-1">${item.name}</div>
                                <div class="text-xs text-gray-500 mt-0.5">Ph√¢n lo·∫°i: <span class="font-bold">${item.variant}</span></div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-xs bg-white border px-1.5 rounded text-gray-600">x${item.qty}</span>
                                    <span class="text-sm font-bold text-[#ee4d2d]">${formatMoney(item.price)}</span>
                                </div>
                            </div>
                        </div>`;
                    });
                }

                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            });
        }

        function updateOrderStatus() {
            const newStatus = document.getElementById('odStatusSelect').value;
            if(currentOrderId) {
                db.collection("orders").doc(currentOrderId).update({
                    status: newStatus
                }).then(() => {
                    // Show small toast instead of alert
                    const btn = document.querySelector('#odStatusSelect').nextElementSibling;
                    const oldText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> ƒê√£ L∆∞u!';
                    btn.classList.add('bg-green-600');
                    setTimeout(() => {
                        btn.innerHTML = oldText;
                        btn.classList.remove('bg-green-600');
                        closeModal('orderDetailModal');
                    }, 800);
                });
            }
        }

        // --- PRODUCTS LOGIC ---
        function loadProducts() {
            const grid = document.getElementById('productList');
            grid.innerHTML = '<div class="col-span-full text-center py-10"><div class="loader mx-auto"></div></div>';
            
            db.collection("products").orderBy("createdAt", "desc").get().then(snap => {
                let html = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    html += `
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-md transition relative group">
                        <div class="aspect-square bg-gray-100 relative overflow-hidden">
                            <img src="${p.images?.[0] || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                            <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center gap-3 transition">
                                <button onclick="editProduct('${doc.id}')" class="bg-white text-blue-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-50 shadow-lg"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteProduct('${doc.id}')" class="bg-white text-red-500 w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-50 shadow-lg"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-gray-800 line-clamp-1 text-sm mb-1">${p.name}</h3>
                            <div class="flex justify-between items-center">
                                <span class="text-[#ee4d2d] font-bold text-sm">${formatMoney(p.basePrice)}</span>
                                <span class="text-[10px] text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">${p.variants?.length || 0} lo·∫°i</span>
                            </div>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
            });
        }

        function openProductModal() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('pImgPreview').src = 'https://via.placeholder.com/100?text=IMG';
            document.getElementById('variantContainer').innerHTML = '';
            
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            });
        }

        function editProduct(id) {
            db.collection("products").doc(id).get().then(doc => {
                if(!doc.exists) return;
                const p = doc.data();
                document.getElementById('productId').value = id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pPrice').value = p.basePrice;
                document.getElementById('pDesc').value = p.description || '';
                document.getElementById('pImg').value = p.images?.[0] || '';
                if(p.images?.[0]) {
                    document.getElementById('pImgPreview').src = p.images[0];
                }

                const vContainer = document.getElementById('variantContainer');
                vContainer.innerHTML = '';
                if(p.variants) {
                    p.variants.forEach(v => addVariantRow(v.name, v.price, v.image));
                }
                
                const modal = document.getElementById('productModal');
                const content = document.getElementById('productModalContent');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                });
            });
        }

        function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const variants = [];
            document.querySelectorAll('.variant-row').forEach(row => {
                variants.push({
                    name: row.querySelector('.v-name').value,
                    price: parseInt(row.querySelector('.v-price').value) || 0,
                    image: row.querySelector('.v-img').value
                });
            });

            const data = {
                name: document.getElementById('pName').value,
                basePrice: parseInt(document.getElementById('pPrice').value),
                description: document.getElementById('pDesc').value,
                images: [document.getElementById('pImg').value],
                variants: variants,
                createdAt: id ? undefined : firebase.firestore.FieldValue.serverTimestamp()
            };
            if(id) delete data.createdAt; else data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

            const promise = id ? db.collection("products").doc(id).update(data) : db.collection("products").add(data);

            promise.then(() => {
                closeModal('productModal');
                loadProducts();
            });
        }

        function deleteProduct(id) {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) {
                db.collection("products").doc(id).delete().then(() => loadProducts());
            }
        }

        function addVariantRow(name='', price='', img='') {
            const div = document.createElement('div');
            div.className = 'variant-row flex gap-2 items-center bg-white p-2 rounded border border-gray-200 shadow-sm mb-2';
            div.innerHTML = `
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <input type="text" class="v-name border p-1.5 rounded text-sm outline-none focus:border-blue-500" placeholder="T√™n (ƒê·ªè/L)" value="${name}" required>
                    <input type="number" class="v-price border p-1.5 rounded text-sm outline-none focus:border-blue-500" placeholder="Gi√° ti·ªÅn" value="${price}" required>
                    <input type="text" class="v-img border p-1.5 rounded text-sm outline-none focus:border-blue-500 col-span-2" placeholder="Link ·∫£nh bi·∫øn th·ªÉ (t√πy ch·ªçn)" value="${img}">
                </div>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-trash"></i></button>
            `;
            document.getElementById('variantContainer').appendChild(div);
        }

        // --- UTILS ---
        function closeModal(id) { 
            const modal = document.getElementById(id);
            const content = modal.firstElementChild;
            modal.classList.add('opacity-0');
            if(content) content.classList.remove('scale-100');
            if(content) content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 200); 
        }
        function formatMoney(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }
        function formatDate(d) { return d.toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' }); }
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if(seconds < 60) return 'V·ª´a xong';
            const minutes = Math.floor(seconds / 60);
            if(minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            const hours = Math.floor(minutes / 60);
            if(hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            return formatDate(date);
        }
        function getStatusText(s) { 
            const map = { 'new': 'M·ªõi', 'shipping': 'ƒêang giao', 'done': 'Ho√†n th√†nh', 'cancel': 'ƒê√£ h·ªßy' };
            return map[s] || s;
        }
        function getStatusColor(s) {
            const map = { 'new': 'bg-blue-100 text-blue-700 border-blue-200', 'shipping': 'bg-orange-100 text-orange-700 border-orange-200', 'done': 'bg-green-100 text-green-700 border-green-200', 'cancel': 'bg-red-50 text-red-600 border-red-100' };
            return map[s] || 'bg-gray-100 text-gray-600';
        }

        // START
        window.onload = checkAuth;
    </script>
</body>
</html>
